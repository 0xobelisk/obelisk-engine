System.register(["./deprecated-48c82c8e.js","./director-c293a59c.js","./index-0ef5c171.js","./index-433d8403.js","./pipeline-state-manager-c8832894.js","./buffer-barrier-8663498b.js","./instantiated-08b98af3.js","./physics-framework.js","./collision-matrix-00c79502.js","./array-collision-matrix-9005c23d.js","./tuple-dictionary-fbc126e2.js","./util-42015a41.js","./node-event-0336ef70.js","./touch-08df655d.js","./mesh-8d5cf67e.js","./wasm-minigame-04dca4c4.js","./skeleton-389ab8d7.js","./terrain-asset-7cf62450.js","./base.js","./deprecated-6c3e37bc.js","./builtin-pipelines-6a694dc9.js","./deprecated-91fd6294.js","./camera-component-67be14d4.js","./model-renderer-0476c968.js","./renderer-8d761016.js","./instantiate-922c0093.js","./move-70dd8d70.js","./capsule-5d7e8691.js"],(function(){"use strict";var t,i,e,s,n,o,r,a,l,h,c,d,p,_,u,g,f,y,m,C,S,T,B,v,w,b,D,E,A,M,O,R,I,F,x,G;return{setters:[function(e){t=e.g,i=e.G},function(t){e=t.aD,s=t.aU},function(t){n=t.P,o=t.q,r=t.s},function(t){a=t.bC,l=t.o,h=t.Q,c=t.t,d=t.B,p=t.bW,_=t.e,u=t.bF,g=t.a5,f=t.a6,y=t.w,m=t.N,C=t.cT},function(){},function(t){S=t.v},function(t){T=t.b,B=t.a,v=t.E,w=t.c,b=t.d},function(){},function(t){D=t.P,E=t.a,A=t.b,M=t.c,O=t.g,R=t.h},function(t){I=t.A},function(t){F=t.T},function(t){x=t.V,G=t.a},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){}],execute:function(){var L={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},P={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},k={type:"onControllerTriggerEnter",collider:null,characterController:null,impl:null},V=function(){function t(){this.BT_TRANSFORM_0=T.Transform_new(),this.BT_TRANSFORM_1=T.Transform_new(),this.BT_V3_0=T.Vec3_new(0,0,0),this.BT_V3_1=T.Vec3_new(0,0,0),this.BT_V3_2=T.Vec3_new(0,0,0),this.BT_QUAT_0=T.Quat_new(0,0,0,1)}return t.setWrapper=function(t,i,e){this.ROOT[i]||(this.ROOT[i]={}),this.ROOT[i][t]=e},t.delWrapper=function(t,i){delete this.ROOT[i][t]},t.getWrapper=function(t,i){return this.ROOT[i][t]},t.isNotEmptyShape=function(t){return t!==T.EmptyShape_static()},a(t,null,[{key:"instance",get:function(){return null==t._instance&&(t._instance=new t),t._instance}}]),t}();V._instance=void 0,V.ROOT={};var N=new l,W=new l,H=new l,j=new h,z=new h,U=new c;new c;var Y,J,Q,Z,K,X=new d;function q(t,i){return T.Vec3_set(t,i.x,i.y,i.z),t}function $(t,i){var e=T.HEAPF32.subarray(i/4,i/4+3);return t.x=e[0],t.y=e[1],t.z=e[2],t}function tt(t,i){return T.Quat_set(t,i.x,i.y,i.z,i.w),t}function it(t,i){var e=T.HEAPF32.subarray(i/4,i/4+4);return t.x=e[0],t.y=e[1],t.z=e[2],t.w=e[3],t}function et(t,i){for(var e=i.renderingSubMeshes.length,s=0;s<e;s++){var n=i.renderingSubMeshes[s],o=n.geometricInfo;if(o){var r=n.primitiveMode,a=o.positions,l=o.indices,h=V.instance.BT_V3_0,c=V.instance.BT_V3_1,d=V.instance.BT_V3_2;if(r===S.TRIANGLE_LIST)for(var p=l.length,_=0;_<p;_+=3){var u=3*l[_],g=3*l[_+1],f=3*l[_+2];T.Vec3_set(h,a[u],a[u+1],a[u+2]),T.Vec3_set(c,a[g],a[g+1],a[g+2]),T.Vec3_set(d,a[f],a[f+1],a[f+2]),T.TriangleMesh_addTriangle(t,h,c,d,!1)}else if(r===S.TRIANGLE_STRIP)for(var y=l.length-2,m=0,C=0;C<y;C+=1){var B=3*l[C-m],v=3*l[C+m+1],w=3*l[C+2];m=~m,T.Vec3_set(h,a[B],a[B+1],a[B+2]),T.Vec3_set(c,a[v],a[v+1],a[v+2]),T.Vec3_set(d,a[w],a[w+1],a[w+2]),T.TriangleMesh_addTriangle(t,h,c,d,!1)}else if(r===S.TRIANGLE_FAN){var b=l.length-1,D=3*l[0];T.Vec3_set(h,a[D],a[D+1],a[D+2]);for(var E=1;E<b;E+=1){var A=3*l[E],M=3*l[E+1];T.Vec3_set(c,a[A],a[A+1],a[A+2]),T.Vec3_set(d,a[M],a[M+1],a[M+2]),T.TriangleMesh_addTriangle(t,h,c,d,!1)}}}}return t}function st(t,i){return t*i}B.CACHE=V,function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(Y||(Y={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(J||(J={})),function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(Q||(Q={})),function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(Z||(Z={})),function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(K||(K={}));var nt=N,ot=W,rt=function(){var t=i.prototype;function i(){this.id=void 0,this._isEnabled=!1,this._isUsingCCD=!1,this._sharedBody=void 0,this._rigidBody=void 0,this.id=i.idCounter++}return t.setMass=function(t){this._rigidBody.isDynamic&&(T.RigidBody_setMass(this.impl,t),this._wakeUpIfSleep(),this._sharedBody.dirty|=Y.BODY_RE_ADD)},t.setType=function(t){this._sharedBody.setType(t)},t.setLinearDamping=function(){T.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.setAngularDamping=function(){T.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.useGravity=function(t){if(this._rigidBody.isDynamic){var i=T.RigidBody_getFlags(this.impl);t?i&=~K.BT_DISABLE_WORLD_GRAVITY:(T.RigidBody_setGravity(this.impl,q(V.instance.BT_V3_0,l.ZERO)),i|=K.BT_DISABLE_WORLD_GRAVITY),T.RigidBody_setFlags(this.impl,i),this._wakeUpIfSleep(),this._sharedBody.dirty|=Y.BODY_RE_ADD}},t.useCCD=function(t){T.CollisionObject_setCcdMotionThreshold(this.impl,t?.01:0),T.CollisionObject_setCcdSweptSphereRadius(this.impl,t?.1:0),this._isUsingCCD=t},t.isUsingCCD=function(){return this._isUsingCCD},t.setLinearFactor=function(t){T.RigidBody_setLinearFactor(this.impl,q(V.instance.BT_V3_0,t)),this._wakeUpIfSleep()},t.setAngularFactor=function(t){T.RigidBody_setAngularFactor(this.impl,q(V.instance.BT_V3_0,t)),this._wakeUpIfSleep()},t.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?T.CollisionObject_forceActivationState(this.impl,Z.ACTIVE_TAG):T.CollisionObject_forceActivationState(this.impl,Z.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},t.clearState=function(){T.RigidBody_clearState(this.impl)},t.clearVelocity=function(){this.setLinearVelocity(l.ZERO),this.setAngularVelocity(l.ZERO)},t.clearForces=function(){T.RigidBody_clearForces(this.impl)},t.initialize=function(t){this._rigidBody=t,this._sharedBody=n.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.wakeUp=function(t){void 0===t&&(t=!0),T.CollisionObject_activate(this.impl,t)},t.sleep=function(){var t=T.CollisionObject_getActivationState(this.impl);t!==Z.DISABLE_DEACTIVATION&&t!==Z.DISABLE_SIMULATION&&T.CollisionObject_forceActivationState(this.impl,Z.ISLAND_SLEEPING)},t.setSleepThreshold=function(t){this._wakeUpIfSleep(),T.RigidBody_setSleepingThresholds(this.impl,t,t)},t.getSleepThreshold=function(){return T.RigidBody_getLinearSleepingThreshold(this.impl)},t.getLinearVelocity=function(t){return $(t,T.RigidBody_getLinearVelocity(this.impl))},t.setLinearVelocity=function(t){this._wakeUpIfSleep(),q(T.RigidBody_getLinearVelocity(this.impl),t)},t.getAngularVelocity=function(t){return $(t,T.RigidBody_getAngularVelocity(this.impl))},t.setAngularVelocity=function(t){this._wakeUpIfSleep(),q(T.RigidBody_getAngularVelocity(this.impl),t)},t.applyLocalForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=this._sharedBody.node.worldRotation,s=l.transformQuat(nt,t,e),n=i?l.transformQuat(ot,i,e):l.ZERO;T.RigidBody_applyForce(this.impl,q(V.instance.BT_V3_0,s),q(V.instance.BT_V3_1,n))},t.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),l.transformQuat(nt,t,this._sharedBody.node.worldRotation),T.RigidBody_applyTorque(this.impl,q(V.instance.BT_V3_0,nt))},t.applyLocalImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=this._sharedBody.node.worldRotation,s=l.transformQuat(nt,t,e),n=i?l.transformQuat(ot,i,e):l.ZERO;T.RigidBody_applyImpulse(this.impl,q(V.instance.BT_V3_0,s),q(V.instance.BT_V3_1,n))},t.applyForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=i||l.ZERO;T.RigidBody_applyForce(this.impl,q(V.instance.BT_V3_0,t),q(V.instance.BT_V3_1,e))},t.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),T.RigidBody_applyTorque(this.impl,q(V.instance.BT_V3_0,t))},t.applyImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=i||l.ZERO;T.RigidBody_applyImpulse(this.impl,q(V.instance.BT_V3_0,t),q(V.instance.BT_V3_1,e))},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t._wakeUpIfSleep=function(){this.isAwake||T.CollisionObject_activate(this.impl,!0)},a(i,[{key:"isAwake",get:function(){var t=T.CollisionObject_getActivationState(this.impl);return t===Z.ACTIVE_TAG||t===Z.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return T.CollisionObject_getActivationState(this.impl)===Z.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return T.CollisionObject_getActivationState(this.impl)===Z.ISLAND_SLEEPING}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),i}();rt.idCounter=0;var at={syncPhysicsToGraphics:function(t){B.CACHE.getWrapper(t,B.BODY_CACHE_NAME).syncPhysicsToGraphics()},onShapeHitExt:function(t,i){B.CACHE.getWrapper(i,B.CCT_CACHE_NAME).onShapeHitExt(t)},onDebugDrawLine:function(t,i,e){var s=B.CACHE.world;s&&s.onDebugDrawLine(t,i,e)},clearLines:function(){var t=B.CACHE.world;t&&t.onClearLines()},flushLines:function(){}},lt=N,ht=j,ct=0,dt=function(){function t(i,e){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=n.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._bodyStruct=void 0,this._ghostStruct=void 0,this._wrappedBody=null,this.id=t.idCounter++,this.wrappedWorld=e,this.node=i}t.getSharedBody=function(i,e,s){var o,r=i.uuid;if(t.sharedBodesMap.has(r))o=t.sharedBodesMap.get(r);else{o=new t(i,e);var a=D.DEFAULT,l=n.instance.collisionMatrix[a];o._collisionFilterGroup=a,o._collisionFilterMask=l,t.sharedBodesMap.set(i.uuid,o)}if(s){o._wrappedBody=s;var h=s.rigidBody.group,c=n.instance.collisionMatrix[h];o._collisionFilterGroup=h,o._collisionFilterMask=c}return o};var i=t.prototype;return i._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=0;this._wrappedBody&&this._wrappedBody.rigidBody.enabled&&this._wrappedBody.rigidBody.isDynamic&&(t=this._wrappedBody.rigidBody.mass);var i=V.instance.BT_TRANSFORM_0,e=V.instance.BT_QUAT_0;q(T.Transform_getOrigin(i),this.node.worldPosition),tt(e,this.node.worldRotation),T.Transform_setRotation(i,e);var s=T.MotionState.implement(at).$$.ptr;T.ccMotionState_setup(s,this.id,i);var o=T.RigidBody_new(t,s),r=n.instance.sleepThreshold;T.RigidBody_setSleepingThresholds(o,r,r),this._bodyStruct={id:ct++,body:o,motionState:s,compound:T.ccCompoundShape_new(),wrappedShapes:[],useCompound:!1},V.setWrapper(this.id,B.BODY_CACHE_NAME,this),this._ghostStruct&&T.CollisionObject_setIgnoreCollisionCheck(this.ghost,this.body,!0),this._wrappedBody&&this.setBodyType(this._wrappedBody.rigidBody.type)}},i._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=T.CollisionObject_new(),i=T.ccCompoundShape_new();T.CollisionObject_setCollisionShape(t,i),T.CollisionObject_setCollisionFlags(t,J.CF_STATIC_OBJECT|J.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:ct++,ghost:t,compound:i,wrappedShapes:[]},this._bodyStruct&&T.CollisionObject_setIgnoreCollisionCheck(this.body,this.ghost,!0),this._wrappedBody&&this.setGhostType(this._wrappedBody.rigidBody.type)}},i.setType=function(t){this.setBodyType(t),this.setGhostType(t)},i.setBodyType=function(t){if(this._bodyStruct&&this._wrappedBody){var i=this._bodyStruct.body,e=this._wrappedBody,s=e.rigidBody,n=T.CollisionObject_getCollisionFlags(i),o=V.instance.BT_V3_0;switch(t){case E.DYNAMIC:n&=~J.CF_KINEMATIC_OBJECT,n&=~J.CF_STATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,n),e.setMass(s.mass),e.useGravity(s.useGravity),e.setAllowSleep(s.allowSleep);break;case E.KINEMATIC:T.Vec3_set(o,0,0,0),T.RigidBody_setMassProps(i,0,o),n|=J.CF_KINEMATIC_OBJECT,n&=~J.CF_STATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,n),T.CollisionObject_forceActivationState(i,Z.DISABLE_DEACTIVATION);break;case E.STATIC:default:T.Vec3_set(o,0,0,0),T.RigidBody_setMassProps(i,0,o),n|=J.CF_STATIC_OBJECT,n&=~J.CF_KINEMATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,n),T.CollisionObject_forceActivationState(i,Z.ISLAND_SLEEPING)}this.dirty|=Y.BODY_RE_ADD}},i.setGhostType=function(t){if(this._ghostStruct){var i=this._ghostStruct.ghost,e=T.CollisionObject_getCollisionFlags(i);switch(t){case E.DYNAMIC:case E.KINEMATIC:e&=~J.CF_STATIC_OBJECT,e|=J.CF_KINEMATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,e),T.CollisionObject_forceActivationState(i,Z.DISABLE_DEACTIVATION);break;case E.STATIC:default:e&=~J.CF_KINEMATIC_OBJECT,e|=J.CF_STATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,e),T.CollisionObject_forceActivationState(i,Z.ISLAND_SLEEPING)}this.dirty|=Y.GHOST_RE_ADD}},i.addShape=function(t,i){function e(t,i){T.CollisionObject_setCollisionShape(t.body,i),t.dirty|=Y.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!==s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var n=0;n<s;n++)this.bodyStruct.wrappedShapes[n].setCompound(this.bodyCompoundShape);e(this,this.bodyStruct.compound)}else e(this,t.impl)}this.bodyEnabled=!0}},i.removeShape=function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(p(this.ghostStruct.wrappedShapes,e),t.setCompound(0),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(0):T.CollisionObject_setCollisionShape(this.body,T.EmptyShape_static()),T.CollisionObject_activate(this.body,!0),this.dirty|=Y.BODY_RE_ADD,p(this.bodyStruct.wrappedShapes,s),this.bodyEnabled=!1)}},i.addJoint=function(t,i){i?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},i.removeJoint=function(t,i){if(i){var e=this.wrappedJoints1.indexOf(t);e>=0&&p(this.wrappedJoints1,e)}else{var s=this.wrappedJoints0.indexOf(t);s>=0&&p(this.wrappedJoints0,s)}},i.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&Y.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&Y.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},i.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=V.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.body);if(tt(t,this.node.worldRotation),q(T.Transform_getOrigin(i),this.node.worldPosition),T.Transform_setRotation(i,t),this.node.hasChangedFlags&e.SCALE&&this.syncBodyScale(),T.CollisionObject_isKinematicObject(this.body)){var s=T.RigidBody_getMotionState(this.body);s&&T.MotionState_setWorldTransform(s,i)}else this.isBodySleeping()&&T.CollisionObject_activate(this.body,!1)}},i.syncPhysicsToScene=function(){T.CollisionObject_isStaticOrKinematicObject(this.body)||this.syncPhysicsToGraphics()},i.syncPhysicsToGraphics=function(){if(!this.isBodySleeping()){var t=V.instance.BT_QUAT_0,i=V.instance.BT_TRANSFORM_0;T.RigidBody_getWorldTransform(this.body,i);var e=T.Transform_getRotationAndOrigin(i,t);if(this.node.worldRotation=it(ht,t),this.node.worldPosition=$(lt,e),this._ghostStruct){var s=T.CollisionObject_getWorldTransform(this.ghost);q(T.Transform_getOrigin(s),this.node.worldPosition),tt(t,this.node.worldRotation),T.Transform_setRotation(s,t)}}},i.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=V.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.ghost);q(T.Transform_getOrigin(i),this.node.worldPosition),tt(t,this.node.worldRotation),T.Transform_setRotation(i,t),this.node.hasChangedFlags&e.SCALE&&this.syncGhostScale(),T.CollisionObject_activate(this.ghost,!1)}},i.syncInitialBody=function(){var t=V.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.body);q(T.Transform_getOrigin(i),this.node.worldPosition),tt(t,this.node.worldRotation),T.Transform_setRotation(i,t),this.syncBodyScale(),T.CollisionObject_activate(this.body,!1)},i.syncInitialGhost=function(){var t=V.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.ghost);q(T.Transform_getOrigin(i),this.node.worldPosition),tt(t,this.node.worldRotation),T.Transform_setRotation(i,t),this.syncGhostScale(),T.CollisionObject_activate(this.body,!1)},i.syncBodyScale=function(){for(var t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].updateScale();for(var i=0;i<this.wrappedJoints0.length;i++)this.wrappedJoints0[i].updateScale0();for(var e=0;e<this.wrappedJoints1.length;e++)this.wrappedJoints1[e].updateScale1()},i.syncGhostScale=function(){for(var t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].updateScale()},i.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},i.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},i.destroy=function(){if(t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var i=this._bodyStruct;V.delWrapper(i.body,B.BODY_CACHE_NAME),T._safe_delete(i.motionState,v.EBulletTypeMotionState),T._safe_delete(i.compound,v.EBulletTypeCollisionShape),T._safe_delete(i.body,v.EBulletTypeCollisionObject),this._bodyStruct=null}if(this._ghostStruct){var e=this._ghostStruct;T._safe_delete(e.compound,v.EBulletTypeCollisionShape),T._safe_delete(e.ghost,v.EBulletTypeCollisionObject),this._ghostStruct=null}},i.isBodySleeping=function(){return T.CollisionObject_isSleeping(this.body)},a(t,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.compound}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.compound}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=Y.BODY_RE_ADD,this.dirty|=Y.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=Y.BODY_RE_ADD,this.dirty|=Y.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){if(t){if(this.bodyIndex<0){if(0===this.bodyStruct.wrappedShapes.length){if(!this.wrappedBody)return;if(!this.wrappedBody.rigidBody.isDynamic)return}this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitialBody()}}else this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(T.RigidBody_clearState(this.body),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();dt.idCounter=0,dt.sharedBodesMap=new Map;var pt=N,_t={},ut=function(){function t(){this.id=t.idCounter++,this._isEnabled=!1,this._isTrigger=!1,this._isInitialized=!1,this._impl=0,this._compound=0,this.quat=T.Quat_new(0,0,0,1),this.transform=T.Transform_new(),this._collider=void 0,this._sharedBody=void 0}var i=t.prototype;return i.updateEventListener=function(){this._sharedBody.wrappedWorld.updateNeedEmitEvents(this.collider.needCollisionEvent||this.collider.needTriggerEvent)},i.setMaterial=function(t){var i=null==t?n.instance.defaultMaterial:t;if(!this._isTrigger&&this._isEnabled)if(this._compound){_t[i._uuid]||(_t[i._uuid]=T.ccMaterial_new());var e=_t[i._uuid];T.ccMaterial_set(e,i.restitution,i.friction,i.rollingFriction,i.spinningFriction),T.CollisionShape_setMaterial(this._impl,e)}else T.CollisionObject_setMaterial(this._sharedBody.body,i.restitution,i.friction,i.rollingFriction,i.spinningFriction)},i.setCenter=function(t){l.copy(pt,t),pt.multiply(this._collider.node.worldScale),q(T.Transform_getOrigin(this.transform),pt),this.updateCompoundTransform()},i.setAsTrigger=function(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},i.getAABB=function(t){var i=V.instance.BT_TRANSFORM_0;T.Transform_setIdentity(i),T.Transform_setRotation(i,tt(V.instance.BT_QUAT_0,this._collider.node.worldRotation));var e=V.instance.BT_V3_0,s=V.instance.BT_V3_1;T.CollisionShape_getAabb(this._impl,i,e,s),t.halfExtents.x=(T.Vec3_x(s)-T.Vec3_x(e))/2,t.halfExtents.y=(T.Vec3_y(s)-T.Vec3_y(e))/2,t.halfExtents.z=(T.Vec3_z(s)-T.Vec3_z(e))/2,l.add(t.center,this._collider.node.worldPosition,this._collider.center)},i.getBoundingSphere=function(t){t.radius=T.CollisionShape_getLocalBoundingSphere(this._impl),l.add(t.center,this._collider.node.worldPosition,this._collider.center)},i.initialize=function(t){this._collider=t,this._isInitialized=!0,this._sharedBody=n.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),this.setWrapper()},i.setWrapper=function(){V.isNotEmptyShape(this._impl)&&(T.CollisionShape_setUserPointer(this._impl,this._impl),V.setWrapper(this._impl,t.TYPE,this))},i.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},i.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},i.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},i.onDestroy=function(){this._sharedBody.reference=!1,this._collider=null,T._safe_delete(this.quat,v.EBulletTypeQuat),T._safe_delete(this.transform,v.EBulletTypeTransform),this._compound&&T._safe_delete(this._compound,v.EBulletTypeCollisionShape),V.isNotEmptyShape(this._impl)&&(T._safe_delete(this._impl,v.EBulletTypeCollisionShape),V.delWrapper(this._impl,t.TYPE))},i.updateByReAdd=function(){this._isEnabled&&(this._sharedBody.removeShape(this,this._isTrigger),this._sharedBody.addShape(this,this._isTrigger))},i.getGroup=function(){return this._sharedBody.collisionFilterGroup},i.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},i.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},i.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},i.getMask=function(){return this._sharedBody.collisionFilterMask},i.setMask=function(t){this._sharedBody.collisionFilterMask=t},i.addMask=function(t){this._sharedBody.collisionFilterMask|=t},i.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},i.setCompound=function(t){this._compound&&T.CompoundShape_removeChildShape(this._compound,this._impl),t&&T.CompoundShape_addChildShape(t,this.transform,this._impl),this._compound=t},i.updateScale=function(){this.setCenter(this._collider.center)},i.updateCompoundTransform=function(){this._compound?T.CompoundShape_updateChildTransform(this._compound,this._impl,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=Y.BODY_RE_ADD)},i.needCompound=function(){return this._collider.type===A.TERRAIN||!this._collider.center.equals(l.ZERO)},a(t,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}}]),t}();ut.TYPE="shape",ut.idCounter=0;var gt=function(){function t(t){this.impl=0,this.event=void 0,this.event=t}var i=t.prototype;return i.getLocalPointOnA=function(t){this.impl&&$(t,T.ManifoldPoint_get_m_localPointA(this.impl))},i.getLocalPointOnB=function(t){this.impl&&$(t,T.ManifoldPoint_get_m_localPointB(this.impl))},i.getWorldPointOnA=function(t){this.impl&&$(t,T.ManifoldPoint_get_m_positionWorldOnA(this.impl))},i.getWorldPointOnB=function(t){this.impl&&$(t,T.ManifoldPoint_get_m_positionWorldOnB(this.impl))},i.getLocalNormalOnA=function(t){if(this.impl){var i=V.instance.BT_QUAT_0,e=T.PersistentManifold_getBody0(this.event.impl),s=T.CollisionObject_getWorldTransform(e);T.Transform_getRotation(s,i);var n=j;it(n,i),h.conjugate(n,n),$(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||l.negate(t,t),l.transformQuat(t,t,n)}},i.getLocalNormalOnB=function(t){if(this.impl){var i=V.instance.BT_QUAT_0,e=T.PersistentManifold_getBody1(this.event.impl),s=T.CollisionObject_getWorldTransform(e);T.Transform_getRotation(s,i);var n=j;it(n,i),h.conjugate(n,n),$(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl)),l.transformQuat(t,t,n)}},i.getWorldNormalOnA=function(t){this.impl&&($(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||l.negate(t,t))},i.getWorldNormalOnB=function(t){this.impl&&$(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl))},a(t,[{key:"isBodyA",get:function(){return this.event.selfCollider.shape.sharedBody.body===T.PersistentManifold_getBody0(this.event.impl)}}]),t}(),ft=[],yt=N,mt=W,Ct=H,St=X,Tt=new o,Bt=function(){var t=i.prototype;function i(){this._world=void 0,this._broadphase=void 0,this._solver=void 0,this._dispatcher=void 0,this._debugDraw=void 0,this._debugLineCount=0,this._MAX_DEBUG_LINE_COUNT=16384,this._debugDrawFlags=M.NONE,this._debugConstraintSize=.3,this._needEmitEvents=!1,this._needSyncAfterEvents=!1,this._needEmitCCTEvents=!1,this.bodies=[],this.ghosts=[],this.ccts=[],this.constraints=[],this.triggerArrayMat=new I,this.collisionArrayMat=new I,this.contactsDic=new F,this.oldContactsDic=new F,this.cctShapeEventDic=new F,this.cctContactsDic=new F,this.cctOldContactsDic=new F,B.CACHE.world=this,this._broadphase=T.DbvtBroadphase_new(),this._dispatcher=T.CollisionDispatcher_new(),this._solver=T.SequentialImpulseConstraintSolver_new(),this._world=T.ccDiscreteDynamicsWorld_new(this._dispatcher,this._broadphase,this._solver);var t=T.DebugDraw.implement(at);this._debugDraw=t.$$.ptr,T.CollisionWorld_setDebugDrawer(this._world,this._debugDraw),T.DebugDraw_setDebugMode(this._debugDraw,w.DBG_NoDebug),T.DebugDraw_setAABBColor(this._debugDraw,0,1,1),T.DebugDraw_setActiveObjectColor(this._debugDraw,1,0,1),T.DebugDraw_setDeactiveObjectColor(this._debugDraw,1,0,1),T.DebugDraw_setWantsDeactivationObjectColor(this._debugDraw,1,0,1),T.DebugDraw_setDisabledDeactivationObjectColor(this._debugDraw,1,0,1),T.DebugDraw_setDisabledSimulationObjectColor(this._debugDraw,1,0,1),T.DebugDraw_setConstraintLimitColor(this._debugDraw,.5,.5,.5)}return t.setDefaultMaterial=function(){},t.setAllowSleep=function(t){T.ccDiscreteDynamicsWorld_setAllowSleep(this._world,t)},t.setGravity=function(t){T.DynamicsWorld_setGravity(this._world,q(V.instance.BT_V3_0,t))},t.updateNeedEmitEvents=function(t){if(this.ghosts)if(t)this._needEmitEvents=!0;else{this._needEmitEvents=!1;for(var i=0;i<this.ghosts.length;i++)for(var e=this.ghosts[i].ghostStruct.wrappedShapes,s=0;s<e.length;s++){var n=e[s].collider;if(n.needCollisionEvent||n.needTriggerEvent)return void(this._needEmitEvents=!0)}for(var o=0;o<this.bodies.length;o++)for(var r=this.bodies[o].bodyStruct.wrappedShapes,a=0;a<r.length;a++){var l=r[a].collider;if(l.needCollisionEvent||l.needTriggerEvent)return void(this._needEmitEvents=!0)}}},t.updateNeedEmitCCTEvents=function(t){if(this.ccts)if(t)this._needEmitCCTEvents=!0;else{this._needEmitCCTEvents=!1;for(var i=this.ccts,e=i.length,s=0;s<e;s++)if(i[s].characterController.needCollisionEvent)return void(this._needEmitCCTEvents=!0)}},t.destroy=function(){(this.constraints.length||this.bodies.length||this.ccts.length)&&_("You should destroy all physics component first."),T._safe_delete(this._world,v.EBulletTypeCollisionWorld),T._safe_delete(this._broadphase,v.EBulletTypeDbvtBroadPhase),T._safe_delete(this._dispatcher,v.EBulletTypeCollisionDispatcher),T._safe_delete(this._solver,v.EBulletTypeSequentialImpulseConstraintSolver),T._safe_delete(this._debugDraw,v.EBulletTypeDebugDraw),this.bodies=null,this.ghosts=null,this.ccts=null,this.constraints=null,this.triggerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,this.cctShapeEventDic=null,this.cctShapeEventPool=null,ft.length=0},t.step=function(t,i,e){void 0===e&&(e=0),(this.bodies.length||this.ghosts.length)&&(void 0===i&&(i=t),T.DynamicsWorld_stepSimulation(this._world,i,e,t),T.CollisionWorld_debugDrawWorld(this._world))},t.syncSceneToPhysics=function(){for(var t=this.ghosts.length-1;t>=0;t--){var i=this.ghosts[t];i.updateDirty(),i.syncSceneToGhost()}for(var e=this.bodies.length-1;e>=0;e--){var s=this.bodies[e];s.updateDirty(),s.syncSceneToPhysics()}for(var n=this.ccts,o=n.length-1;o>=0;o--){var r=n[o];r.updateDirty(),r.syncSceneToPhysics()}},t.syncAfterEvents=function(){this._needSyncAfterEvents&&this.syncSceneToPhysics()},t.raycast=function(t,i,e,s){t.computeHit(yt,i.maxDistance);var n=q(V.instance.BT_V3_0,yt),o=q(V.instance.BT_V3_1,t.o),r=T.ccAllRayCallback_static();if(T.ccAllRayCallback_reset(r,o,n,i.mask>>>0,i.queryTrigger),T.ccAllRayCallback_setFlags(r,b.UseSubSimplexConvexCastRaytest),T.CollisionWorld_rayTest(this._world,o,n,r),T.RayCallback_hasHit(r)){for(var a=T.ccAllRayCallback_getHitPointWorld(r),h=T.ccAllRayCallback_getHitNormalWorld(r),c=T.ccAllRayCallback_getCollisionShapePtrs(r),d=0,p=T.int_array_size(c);d<p;d++){$(yt,T.Vec3_array_at(a,d)),$(mt,T.Vec3_array_at(h,d));var _=V.getWrapper(T.int_array_at(c,d),ut.TYPE),u=e.add();s.push(u),u._assign(yt,l.distance(t.o,yt),_.collider,mt)}return!0}return!1},t.raycastClosest=function(t,i,e){t.computeHit(yt,i.maxDistance);var s=q(V.instance.BT_V3_0,yt),n=q(V.instance.BT_V3_1,t.o),o=T.ccClosestRayCallback_static();if(T.ccClosestRayCallback_reset(o,n,s,i.mask>>>0,i.queryTrigger),T.ccClosestRayCallback_setFlags(o,b.UseSubSimplexConvexCastRaytest),T.CollisionWorld_rayTest(this._world,n,s,o),T.RayCallback_hasHit(o)){$(yt,T.ccClosestRayCallback_getHitPointWorld(o)),$(mt,T.ccClosestRayCallback_getHitNormalWorld(o));var r=V.getWrapper(T.ccClosestRayCallback_getCollisionShapePtr(o),ut.TYPE);return e._assign(yt,l.distance(t.o,yt),r.collider,mt),!0}return!1},t.sweepBox=function(t,e,s,n,o,r){var a=V.instance.BT_V3_0;return q(a,e),i._sweepBoxGeometry||(i._sweepBoxGeometry=T.BoxShape_new(a)),T.BoxShape_setUnscaledHalfExtents(i._sweepBoxGeometry,a),this.sweep(t,i._sweepBoxGeometry,s,n,o,r)},t.sweepBoxClosest=function(t,e,s,n,o){var r=V.instance.BT_V3_0;return q(r,e),i._sweepBoxGeometry||(i._sweepBoxGeometry=T.BoxShape_new(r)),T.BoxShape_setUnscaledHalfExtents(i._sweepBoxGeometry,r),this.sweepClosest(t,i._sweepBoxGeometry,s,n,o)},t.sweepSphere=function(t,e,s,n,o){return i._sweepSphereGeometry||(i._sweepSphereGeometry=T.SphereShape_new(e)),T.SphereShape_setUnscaledRadius(i._sweepSphereGeometry,e),this.sweep(t,i._sweepSphereGeometry,h.IDENTITY,s,n,o)},t.sweepSphereClosest=function(t,e,s,n){return i._sweepSphereGeometry||(i._sweepSphereGeometry=T.SphereShape_new(e)),T.SphereShape_setUnscaledRadius(i._sweepSphereGeometry,e),this.sweepClosest(t,i._sweepSphereGeometry,h.IDENTITY,s,n)},t.sweepCapsule=function(t,e,s,n,o,r,a){return i._sweepCapsuleGeometry||(i._sweepCapsuleGeometry=T.CapsuleShape_new(e,s)),T.CapsuleShape_updateProp(i._sweepCapsuleGeometry,e,.5*s,1),this.sweep(t,i._sweepCapsuleGeometry,n,o,r,a)},t.sweepCapsuleClosest=function(t,e,s,n,o,r){return i._sweepCapsuleGeometry||(i._sweepCapsuleGeometry=T.CapsuleShape_new(e,s)),T.CapsuleShape_updateProp(i._sweepCapsuleGeometry,e,.5*s,1),this.sweepClosest(t,i._sweepCapsuleGeometry,n,o,r)},t.sweep=function(t,i,e,s,n,o){var r=V.instance.BT_TRANSFORM_0,a=V.instance.BT_TRANSFORM_1,h=V.instance.BT_QUAT_0;q(T.Transform_getOrigin(r),t.o),tt(h,e),T.Transform_setRotation(r,h),t.computeHit(yt,s.maxDistance),q(T.Transform_getOrigin(a),yt),tt(h,e),T.Transform_setRotation(a,h);var c=T.ccAllConvexCallback_static();if(T.ccAllConvexCallback_reset(c,r,a,s.mask>>>0,s.queryTrigger),T.CollisionWorld_convexSweepTest(this._world,i,r,a,c,0),T.ConvexCallback_hasHit(c)){for(var d=T.ccAllConvexCallback_getHitPointWorld(c),p=T.ccAllConvexCallback_getHitNormalWorld(c),_=T.ccAllConvexCallback_getCollisionShapePtrs(c),u=0,g=T.int_array_size(_);u<g;u++){$(yt,T.Vec3_array_at(d,u)),$(mt,T.Vec3_array_at(p,u));var f=V.getWrapper(T.int_array_at(_,u),ut.TYPE),y=n.add();o.push(y),y._assign(yt,l.distance(t.o,yt),f.collider,mt)}return!0}return!1},t.sweepClosest=function(t,i,e,s,n){var o=V.instance.BT_TRANSFORM_0,r=V.instance.BT_TRANSFORM_1,a=V.instance.BT_QUAT_0;q(T.Transform_getOrigin(o),t.o),tt(a,e),T.Transform_setRotation(o,a),t.computeHit(yt,s.maxDistance),q(T.Transform_getOrigin(r),yt),tt(a,e),T.Transform_setRotation(r,a);var h=T.ccClosestConvexCallback_static();if(T.ccClosestConvexCallback_reset(h,o,r,s.mask>>>0,s.queryTrigger),T.CollisionWorld_convexSweepTest(this._world,i,o,r,h,0),T.ConvexCallback_hasHit(h)){$(yt,T.ccClosestConvexCallback_getHitPointWorld(h)),$(mt,T.ccClosestConvexCallback_getHitNormalWorld(h));var c=V.getWrapper(T.ccClosestConvexCallback_getCollisionShapePtr(h),ut.TYPE);return n._assign(yt,l.distance(t.o,yt),c.collider,mt),!0}return!1},t.getSharedBody=function(t,i){return dt.getSharedBody(t,this,i)},t.addSharedBody=function(t){if(this.bodies.indexOf(t)<0){this.bodies.push(t);var i=t.collisionFilterGroup,e=t.collisionFilterMask;T.DynamicsWorld_addRigidBody(this._world,t.body,i>>>0,e>>>0)}},t.removeSharedBody=function(t){var i=this.bodies.indexOf(t);i>=0&&(p(this.bodies,i),T.DynamicsWorld_removeRigidBody(this._world,t.body))},t.addGhostObject=function(t){if(this.ghosts.indexOf(t)<0){this.ghosts.push(t);var i=t.collisionFilterGroup,e=t.collisionFilterMask;T.CollisionWorld_addCollisionObject(this._world,t.ghost,i>>>0,e>>>0)}},t.removeGhostObject=function(t){var i=this.ghosts.indexOf(t);i>=0&&(p(this.ghosts,i),T.CollisionWorld_removeCollisionObject(this._world,t.ghost))},t.addCCT=function(t){if(this.ccts.indexOf(t)<0){this.ccts.push(t);var i=T.CharacterController_getGhostObject(t.impl),e=t.getGroup(),s=t.getMask();T.CollisionWorld_addCollisionObject(this._world,i,e>>>0,s>>>0),T.DynamicsWorld_addAction(this._world,t.impl)}},t.removeCCT=function(t){var i=this.ccts.indexOf(t);if(i>=0){p(this.ccts,i);var e=T.CharacterController_getGhostObject(t.impl);T.CollisionWorld_removeCollisionObject(this._world,e),T.DynamicsWorld_removeAction(this._world,t.impl)}},t.addConstraint=function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),T.DynamicsWorld_addConstraint(this.impl,t.impl,!t.constraint.enableCollision),t.index=i)},t.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),T.DynamicsWorld_removeConstraint(this.impl,t.impl),t.index=-1)},t.emitEvents=function(){this._needSyncAfterEvents=!1,this._needEmitEvents&&(this.gatherConatactData(),this.emitCollisionAndTriggerEvent(),this.emitCCTTriggerEvent()),this._needEmitCCTEvents&&this.emitCCTCollisionEvent()},t.emitCollisionAndTriggerEvent=function(){for(var t=this.contactsDic.getLength();t--;){ft.push.apply(ft,P.contacts),P.contacts.length=0;var i=this.contactsDic.getKeyByIndex(t),e=this.contactsDic.getDataByKey(i),s=e.shape0,n=e.shape1;this.oldContactsDic.set(s.id,n.id,e);var o=s.collider,r=n.collider;if(o&&r){if(o.isTrigger||r.isTrigger)this.triggerArrayMat.get(s.id,n.id)?L.type="onTriggerStay":(L.type="onTriggerEnter",this.triggerArrayMat.set(s.id,n.id,!0)),L.impl=e.impl,L.selfCollider=o,L.otherCollider=r,o.emit(L.type,L),L.selfCollider=r,L.otherCollider=o,r.emit(L.type,L),this._needSyncAfterEvents=!0;else{var a=o.attachedRigidBody,l=r.attachedRigidBody;if(a&&l){if(a.isSleeping&&l.isSleeping)continue}else if(!a&&l){if(l.isSleeping)continue}else if(!l&&a&&a.isSleeping)continue;this.collisionArrayMat.get(s.id,n.id)?P.type="onCollisionStay":(P.type="onCollisionEnter",this.collisionArrayMat.set(s.id,n.id,!0));for(var h=0;h<e.contacts.length;h++){var c=e.contacts[h];if(ft.length>0){var d=ft.pop();d.impl=c,P.contacts.push(d)}else{var p=new gt(P);p.impl=c,P.contacts.push(p)}}P.impl=e.impl,P.selfCollider=o,P.otherCollider=r,o.emit(P.type,P),P.selfCollider=r,P.otherCollider=o,r.emit(P.type,P),this._needSyncAfterEvents=!0}null==this.oldContactsDic.get(s.id,n.id)&&this.oldContactsDic.set(s.id,n.id,e)}}for(var _=this.oldContactsDic.getLength();_--;){var u=this.oldContactsDic.getKeyByIndex(_),g=this.oldContactsDic.getDataByKey(u),f=g.shape0,y=g.shape1,m=f.collider,C=y.collider;if(m&&C){var S=m.isTrigger||C.isTrigger;null==this.contactsDic.getDataByKey(u)&&(S?this.triggerArrayMat.get(f.id,y.id)&&(L.type="onTriggerExit",L.selfCollider=m,L.otherCollider=C,m.emit(L.type,L),L.selfCollider=C,L.otherCollider=m,C.emit(L.type,L),this.triggerArrayMat.set(f.id,y.id,!1),this.oldContactsDic.set(f.id,y.id,null),this._needSyncAfterEvents=!0):this.collisionArrayMat.get(f.id,y.id)&&(ft.push.apply(ft,P.contacts),P.contacts.length=0,P.type="onCollisionExit",P.selfCollider=m,P.otherCollider=C,m.emit(P.type,P),P.selfCollider=C,P.otherCollider=m,C.emit(P.type,P),this.collisionArrayMat.set(f.id,y.id,!1),this.oldContactsDic.set(f.id,y.id,null),this._needSyncAfterEvents=!0))}}this.contactsDic.reset()},t.emitCCTTriggerEvent=function(){for(var t=this.cctContactsDic.getLength();t--;){var i=this.cctContactsDic.getKeyByIndex(t),e=this.cctContactsDic.getDataByKey(i),s=e.shape,n=e.cct;this.cctOldContactsDic.set(s.id,n.id,e);var o=s.collider,r=n.characterController;o&&r&&(o.isTrigger&&(this.triggerArrayMat.get(s.id,n.id)?k.type="onControllerTriggerStay":(k.type="onControllerTriggerEnter",this.triggerArrayMat.set(s.id,n.id,!0)),k.impl=e.impl,k.collider=o,k.characterController=r,o.emit(k.type,k),k.collider=o,k.characterController=r,r.emit(k.type,k),this._needSyncAfterEvents=!0),null==this.cctOldContactsDic.get(s.id,n.id)&&this.cctOldContactsDic.set(s.id,n.id,e))}for(var a=this.cctOldContactsDic.getLength();a--;){var l=this.cctOldContactsDic.getKeyByIndex(a),h=this.cctOldContactsDic.getDataByKey(l),c=h.shape,d=h.cct,p=c.collider,_=d.characterController;if(p&&_){var u=p.isTrigger;null==this.cctContactsDic.getDataByKey(l)&&u&&this.triggerArrayMat.get(c.id,d.id)&&(k.type="onControllerTriggerExit",k.collider=p,k.characterController=_,p.emit(k.type,k),k.collider=p,k.characterController=_,_.emit(k.type,k),this.triggerArrayMat.set(c.id,d.id,!1),this.cctOldContactsDic.set(c.id,d.id,null),this._needSyncAfterEvents=!0)}}this.cctContactsDic.reset()},t.emitCCTCollisionEvent=function(){for(var t=this.cctShapeEventDic.getLength();t--;){var i,e=this.cctShapeEventDic.getKeyByIndex(t),s=this.cctShapeEventDic.getDataByKey(e),n=s.BulletCharacterController,o=s.BulletShape,r=s.worldPos,a=s.worldNormal,l=s.motionDir,h=s.motionLength;Tt.controller=n.characterController,Tt.collider=o.collider,Tt.worldPosition.set(r.x,r.y,r.z),Tt.worldNormal.set(a.x,a.y,a.z),Tt.motionDirection.set(l.x,l.y,l.z),Tt.motionLength=h,null===(i=Tt.controller)||void 0===i||i.emit("onControllerColliderHit",Tt),this._needSyncAfterEvents=!0}this.cctShapeEventDic.reset()},t.gatherConatactData=function(){for(var t=T.Dispatcher_getNumManifolds(this._dispatcher),i=0;i<t;i++)for(var e=T.Dispatcher_getManifoldByIndexInternal(this._dispatcher,i),s=T.PersistentManifold_getNumContacts(e),n=0;n<s;n++){var o=T.PersistentManifold_getContactPoint(e,n),r=T.ManifoldPoint_getShape0(o),a=T.ManifoldPoint_getShape1(o),l=!1;if(!l){var h=V.getWrapper(r,ut.TYPE),c=V.getWrapper(a,ut.TYPE);if(h&&c&&(l=!0,h.collider.needTriggerEvent||c.collider.needTriggerEvent||h.collider.needCollisionEvent||c.collider.needCollisionEvent)){var d=this.contactsDic.get(h.id,c.id);d||(d=this.contactsDic.set(h.id,c.id,{shape0:h,shape1:c,contacts:[],impl:e})),d.contacts.push(o)}}if(!l){var p=V.getWrapper(r,ut.TYPE),_=V.getWrapper(a,B.CCT_CACHE_NAME);if(p&&_&&(l=!0,p.collider.needTriggerEvent)){var u=this.cctContactsDic.get(p.id,_.id);u||(u=this.cctContactsDic.set(p.id,_.id,{shape:p,cct:_,contacts:[],impl:e})),u.contacts.push(o),l=!0}}if(!l){var g=V.getWrapper(r,B.CCT_CACHE_NAME),f=V.getWrapper(a,ut.TYPE);if(f&&g&&(l=!0,f.collider.needTriggerEvent)){var y=this.cctContactsDic.get(f.id,g.id);y||(y=this.cctContactsDic.set(f.id,g.id,{shape:f,cct:g,contacts:[],impl:e})),y.contacts.push(o),l=!0}}}},t._setDebugDrawMode=function(){var t=0;this._debugDrawFlags&M.WIRE_FRAME&&(t|=w.DBG_DrawWireframe),this._debugDrawFlags&M.CONSTRAINT&&(t|=w.DBG_DrawConstraints,t|=w.DBG_DrawConstraintLimits),this._debugDrawFlags&M.AABB&&(t|=w.DBG_DrawAabb),T.DebugDraw_setDebugMode(this._debugDraw,t)},t._getDebugRenderer=function(){var t,i=null===(t=s.root.mainWindow)||void 0===t?void 0:t.cameras;return i?0===i.length?null:i[0]?(i[0].initGeometryRenderer(),i[0].geometryRenderer):null:null},t.onDebugDrawLine=function(t,i,e){var s=this._getDebugRenderer();s&&this._debugLineCount<this._MAX_DEBUG_LINE_COUNT&&(this._debugLineCount++,$(yt,t),$(mt,i),$(Ct,e),St.set(255*Ct.x,255*Ct.y,255*Ct.z,255),s.addLine(yt,mt,St))},t.onClearLines=function(){this._debugLineCount=0},a(i,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){this._debugDrawFlags=t,this._debugDraw&&this._setDebugDrawMode()}},{key:"debugDrawConstraintSize",get:function(){return this._debugConstraintSize},set:function(t){this._debugConstraintSize=t;for(var i=0;i<this.constraints.length;i++)this.constraints[i].updateDebugDrawSize()}}]),i}();Bt._sweepBoxGeometry=void 0,Bt._sweepSphereGeometry=void 0,Bt._sweepCapsuleGeometry=void 0;var vt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.updateSize=function(){var t=V.instance.BT_V3_0;q(t,this.getMinUnscaledHalfExtents(x)),T.BoxShape_setUnscaledHalfExtents(this.impl,t),this.updateCompoundTransform()},e.onComponentSet=function(){var t=V.instance.BT_V3_0;q(t,this.getMinUnscaledHalfExtents(x)),this._impl=T.BoxShape_new(t),this.updateScale()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=V.instance.BT_V3_0;T.CollisionShape_setLocalScaling(this._impl,q(i,this.getMinScale(x))),this.updateCompoundTransform()},e.getMinUnscaledHalfExtents=function(t){var i=this.collider.size,e=G(x.set(this._collider.node.worldScale)),s=n.instance.minVolumeSize,o=i.x/2,r=i.y/2,a=i.z/2,l=o*e.x<s?s/e.x:o,h=r*e.y<s?s/e.y:r,c=a*e.z<s?s/e.z:a;return t.set(l,h,c),t},e.getMinScale=function(t){var i=this.collider.size,e=G(x.set(this._collider.node.worldScale)),s=n.instance.minVolumeSize,o=i.x/2,r=i.y/2,a=i.z/2,l=o*e.x<s?s/o:e.x,h=r*e.y<s?s/r:e.y,c=a*e.z<s?s/a:e.z;return t.set(l,h,c),t},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),wt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.updateRadius=function(){T.SphereShape_setUnscaledRadius(this.impl,this.getMinUnscaledRadius()),this.updateCompoundTransform()},e.onComponentSet=function(){this._impl=T.SphereShape_new(this.getMinUnscaledRadius()),this.updateScale()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=this.getMinScale();N.set(i,i,i);var e=V.instance.BT_V3_0;T.CollisionShape_setLocalScaling(this._impl,q(e,N)),this.updateCompoundTransform()},e.getMinUnscaledRadius=function(){var t=this.collider.radius,i=Math.abs(g(this._collider.node.worldScale)),e=n.instance.minVolumeSize;return i*t<e?e/i:t},e.getMinScale=function(){var t=this.collider.radius,i=Math.abs(g(this._collider.node.worldScale)),e=n.instance.minVolumeSize;return i*t<e?e/t:i},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),bt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){this._impl=T.CapsuleShape_new(.5,1),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n,o,r=s,a=e;1===a?(n=t*Math.abs(f(r.x,r.z)),o=i/2*Math.abs(r.y)):0===a?(n=t*Math.abs(f(r.y,r.z)),o=i/2*Math.abs(r.x)):(n=t*Math.abs(f(r.x,r.y)),o=i/2*Math.abs(r.z)),T.CapsuleShape_updateProp(this._impl,n,o,a),this.updateCompoundTransform()},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),Dt=function(){function t(t,i){this.key=void 0,this.ref=0,this.bulletBvhTriangleMeshShapePtr=void 0,this.btTriangleMeshPtr=0,this.reference=!0,this.key=t,this.btTriangleMeshPtr=T.TriangleMesh_new(),et(this.btTriangleMeshPtr,i),this.bulletBvhTriangleMeshShapePtr=T.BvhTriangleMeshShape_new(this.btTriangleMeshPtr,!0,!0)}return t.getBulletBvhTriangleMeshShape=function(i,e){var s;return t.BulletBvhTriangleMeshShapeMap.has(i)?(s=t.BulletBvhTriangleMeshShapeMap.get(i)).reference=!0:(s=new t(i,e),t.BulletBvhTriangleMeshShapeMap.set(i,s)),s},t.prototype.destroy=function(){this.bulletBvhTriangleMeshShapePtr&&T._safe_delete(v.EBulletTypeCollisionShape,this.bulletBvhTriangleMeshShapePtr),this.btTriangleMeshPtr&&T._safe_delete(v.EBulletTypeTriangleMesh,this.btTriangleMeshPtr),t.BulletBvhTriangleMeshShapeMap.delete(this.key)},a(t,[{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();Dt.BulletBvhTriangleMeshShapeMap=new Map;var Et,At,Mt=function(t){function i(){for(var i,e=arguments.length,s=new Array(e),n=0;n<e;n++)s[n]=arguments[n];return(i=t.call.apply(t,[this].concat(s))||this).btBVHMeshShape=void 0,i.refBtTriangleMesh=0,i}u(i,t);var e=i.prototype;return e.setMesh=function(t){if(this._isInitialized){this._impl&&V.isNotEmptyShape(this._impl)&&(this._compound&&T.CompoundShape_removeChildShape(this._compound,this._impl),T._safe_delete(this._impl,v.EBulletTypeCollisionShape),V.delWrapper(this._impl,ut.TYPE),this._impl=0);var i=t;if(i&&i.renderingSubMeshes.length>0){if(this.collider.convex){var e=this._getBtTriangleMesh(i);this._impl=T.ConvexTriangleMeshShape_new(e)}else this.btBVHMeshShape=Dt.getBulletBvhTriangleMeshShape(i.hash,i),this._impl=T.ScaledBvhTriangleMeshShape_new(this.btBVHMeshShape.bulletBvhTriangleMeshShapePtr,1,1,1);var s=V.instance.BT_V3_0;q(s,this._collider.node.worldScale),T.CollisionShape_setLocalScaling(this._impl,s),T.CollisionShape_setMargin(this._impl,.01),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=T.EmptyShape_static()}},e.onComponentSet=function(){this.setMesh(this.collider.mesh)},e.onDestroy=function(){this.collider.convex?this.refBtTriangleMesh&&T._safe_delete(this.refBtTriangleMesh,v.EBulletTypeTriangleMesh):this.btBVHMeshShape&&(this.btBVHMeshShape.reference=!1),t.prototype.onDestroy.call(this)},e.updateScale=function(){t.prototype.updateScale.call(this);var i=V.instance.BT_V3_0;q(i,this._collider.node.worldScale),T.CollisionShape_setLocalScaling(this._impl,i),this.updateCompoundTransform()},e._getBtTriangleMesh=function(t){return this.refBtTriangleMesh=T.TriangleMesh_new(),et(this.refBtTriangleMesh,t),this.refBtTriangleMesh},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),Ot=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){var t=V.instance.BT_V3_0;T.Vec3_set(t,.5,1,.5),this._impl=T.CylinderShape_new(t),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n,o,r=s,a=e;1===a?(o=i*Math.abs(r.y),n=t*Math.abs(f(r.x,r.z))):0===a?(o=i*Math.abs(r.x),n=t*Math.abs(f(r.y,r.z))):(o=i*Math.abs(r.z),n=t*Math.abs(f(r.x,r.y))),T.CylinderShape_updateProp(this._impl,n,o/2,a),this.updateCompoundTransform()},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),Rt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){this._impl=T.ConeShape_new(.5,1),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n,o,r=s,a=e;1===a?(o=i*Math.abs(r.y),n=t*Math.abs(f(r.x,r.z))):0===a?(o=i*Math.abs(r.x),n=t*Math.abs(f(r.y,r.z))):(o=i*Math.abs(r.z),n=t*Math.abs(f(r.x,r.y))),T.ConeShape_setRadius(this._impl,n),T.ConeShape_setHeight(this._impl,o),T.ConeShape_setConeUpIndex(this._impl,a);var l=V.instance.BT_V3_0;T.Vec3_set(l,1,1,1),T.CollisionShape_setLocalScaling(this._impl,l),this.updateCompoundTransform()},a(i,[{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}}]),i}(ut),It=function(t){function i(){for(var i,e=arguments.length,s=new Array(e),n=0;n<e;n++)s[n]=arguments[n];return(i=t.call.apply(t,[this].concat(s))||this)._bufPtr=0,i._tileSize=0,i._localOffset=new l,i}u(i,t);var e=i.prototype;return e.setTerrain=function(t){if(this._isInitialized)if(this._impl&&V.isNotEmptyShape(this._impl))y("[Physics][Bullet]: change the terrain asset after initialization is not support.");else{var i=t;if(i){this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._bufPtr=T._malloc(4*e*s);for(var n=0,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,a=0;a<s;a++)for(var l=0;l<e;l++){var h=i.getHeight(l,a);T._write_f32(this._bufPtr+n,h),o>h&&(o=h),h>r&&(r=h),n+=4}r+=.01,o-=.01,this._localOffset.set((e-1)/2*this._tileSize,(r+o)/2,(s-1)/2*this._tileSize),this._impl=T.TerrainShape_new(e,s,this._bufPtr,1,o,r);var c=V.instance.BT_V3_0;T.Vec3_set(c,this._tileSize,1,this._tileSize),T.CollisionShape_setLocalScaling(this._impl,c),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=T.EmptyShape_static()}},e.onComponentSet=function(){this.setTerrain(this.collider.terrain)},e.onDestroy=function(){this._bufPtr&&T._free(this._bufPtr),t.prototype.onDestroy.call(this)},e.setCenter=function(t){l.copy(N,t),N.add(this._localOffset),q(T.Transform_getOrigin(this.transform),N),this.updateCompoundTransform()},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),Ft=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setShapeType=function(){},e.setVertices=function(){},e.onComponentSet=function(){this._impl=T.SimplexShape_new();for(var t=this.collider.shapeType,i=this.collider.vertices,e=V.instance.BT_V3_0,s=0;s<t;s++)T.SimplexShape_addVertex(this._impl,q(e,i[s]));T.CollisionShape_setLocalScaling(this._impl,q(e,this._collider.node.worldScale))},e.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=V.instance.BT_V3_0;T.CollisionShape_setLocalScaling(this._impl,q(i,this._collider.node.worldScale))},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),xt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setNormal=function(t){q(T.StaticPlaneShape_getPlaneNormal(this.impl),t),this.updateCompoundTransform()},e.setConstant=function(t){T.StaticPlaneShape_setPlaneConstant(this.impl,t),this.updateCompoundTransform()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=V.instance.BT_V3_0;q(i,this._collider.node.worldScale),T.CollisionShape_setLocalScaling(this._impl,i),this.updateCompoundTransform()},e.onComponentSet=function(){var t=V.instance.BT_V3_0;q(t,this.collider.normal),this._impl=T.StaticPlaneShape_new(t,this.collider.constant),this.updateScale()},a(i,[{key:"collider",get:function(){return this._collider}}]),i}(ut),Gt=function(){function t(){this.dirty=0,this.index=-1,this._impl=0,this._com=void 0,this._rigidBody=void 0,this._connectedBody=null,this._collided=!1}var i=t.prototype;return i.setConnectedBody=function(t){if(this._connectedBody!==t){var i=this._connectedBody;i&&i.body.sharedBody.removeJoint(this,1);var e=this._rigidBody.body.sharedBody;e.removeJoint(this,0),this._impl&&(e.wrappedWorld.removeConstraint(this),T._safe_delete(this._impl,v.EBulletTypeTypedConstraint)),this._connectedBody=t;var s=this._connectedBody;this.onComponentSet(),this.setEnableCollision(this._collided),e.wrappedWorld.addConstraint(this),e.addJoint(this,0),s&&s.body.sharedBody.addJoint(this,1)}},i.setEnableCollision=function(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())},i.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},i.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._connectedBody=t.connectedBody,this._collided=t.enableCollision,this.onComponentSet(),this.setEnableCollision(this._collided)},i.updateDebugDrawSize=function(){if(this.impl){var t=n.instance.physicsWorld.debugDrawConstraintSize;T.TypedConstraint_setDbgDrawSize(this.impl,t)}},i.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var i=this._connectedBody;i&&i.body.sharedBody.addJoint(this,1)},i.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var i=this._connectedBody;i&&i.body.sharedBody.removeJoint(this,1)},i.onDestroy=function(){T._safe_delete(this._impl,v.EBulletTypeTypedConstraint),this._com=null,this._rigidBody=null,this._connectedBody=null},a(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),Lt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setPivotA=function(){var t=this.constraint,i=V.instance.BT_V3_0;l.multiply(N,t.node.worldScale,t.pivotA),q(i,N),T.P2PConstraint_setPivotA(this._impl,i),t.connectedBody||this.setPivotB(t.pivotB)},e.setPivotB=function(){var t=this.constraint,i=this._rigidBody.node,e=V.instance.BT_V3_0,s=t.connectedBody;s?(l.multiply(N,s.node.worldScale,t.pivotB),q(e,N)):(l.multiply(N,i.worldScale,t.pivotA),l.transformQuat(N,N,i.worldRotation),l.add(N,N,i.worldPosition),q(e,N)),T.P2PConstraint_setPivotB(this._impl,e)},e.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:T.TypedConstraint_getFixedBody(),s=V.instance.BT_V3_0,n=V.instance.BT_V3_1;this._impl=T.P2PConstraint_new(i,e,s,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.updateDebugDrawSize()},e.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},e.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},a(i,[{key:"constraint",get:function(){return this._com}}]),i}(Gt),Pt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setBreakForce=function(t){T.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},e.setBreakTorque=function(){},e.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:T.TypedConstraint_getFixedBody(),s=V.instance.BT_TRANSFORM_0,n=V.instance.BT_TRANSFORM_1;this._impl=T.FixedConstraint_new(i,e,s,n),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames(),this.updateDebugDrawSize()},e.updateFrames=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.sharedBody,e=N,s=j,n=V.instance.BT_TRANSFORM_0,o=V.instance.BT_TRANSFORM_1,r=V.instance.BT_QUAT_0,a=U;if(c.fromRT(a,i.node.worldRotation,i.node.worldPosition),c.invert(a,a),c.getRotation(s,a),c.getTranslation(e,a),q(T.Transform_getOrigin(n),e),tt(r,s),T.Transform_setRotation(n,r),t){var l=t.body.sharedBody;c.fromRT(a,l.node.worldRotation,l.node.worldPosition),c.invert(a,a),c.getRotation(s,a),c.getTranslation(e,a),q(T.Transform_getOrigin(o),e),tt(r,s),T.Transform_setRotation(o,r)}else T.Transform_setIdentity(o);T.FixedConstraint_setFrames(this._impl,n,o)},e.updateScale0=function(){this.updateFrames()},e.updateScale1=function(){this.updateFrames()},a(i,[{key:"constraint",get:function(){return this._com}}]),i}(Gt),kt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.setPivotA=function(){this.updateFrames()},e.setPivotB=function(){this.updateFrames()},e.setAxis=function(){this.updateFrames()},e.setLimitEnabled=function(){this.constraint.limitEnabled?T.HingeConstraint_setLimit(this._impl,m(this.constraint.lowerLimit),m(this.constraint.upperLimit),.9,.3,1):T.HingeConstraint_setLimit(this._impl,1,0,.9,.3,1)},e.setLowerLimit=function(){this.constraint.limitEnabled&&T.HingeConstraint_setLimit(this._impl,m(this.constraint.lowerLimit),m(this.constraint.upperLimit),.9,.3,1)},e.setUpperLimit=function(){this.constraint.limitEnabled&&T.HingeConstraint_setLimit(this._impl,m(this.constraint.lowerLimit),m(this.constraint.upperLimit),.9,.3,1)},e.setMotorEnabled=function(t){T.HingeConstraint_enableMotor(this._impl,t);var i=-this.constraint.motorVelocity/60,e=st(this.constraint.motorForceLimit,n.instance.fixedTimeStep);T.HingeConstraint_setMotorVelocity(this._impl,i),T.HingeConstraint_setMaxMotorImpulse(this._impl,e)},e.setMotorVelocity=function(t){if(this.constraint.motorEnabled){var i=-t/60;T.HingeConstraint_setMotorVelocity(this._impl,i)}},e.setMotorForceLimit=function(t){if(this.constraint.motorEnabled){var i=st(t,n.instance.fixedTimeStep);T.HingeConstraint_setMaxMotorImpulse(this._impl,i)}},e.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:T.TypedConstraint_getFixedBody(),s=V.instance.BT_TRANSFORM_0,n=V.instance.BT_TRANSFORM_1;this._impl=T.HingeConstraint_new(i,e,s,n),this.setLimitEnabled(this.constraint.limitEnabled),this.setLowerLimit(this.constraint.lowerLimit),this.setUpperLimit(this.constraint.upperLimit),this.setMotorEnabled(this.constraint.motorEnabled),this.setMotorVelocity(this.constraint.motorVelocity),this.setMotorForceLimit(this.constraint.motorForceLimit),this.updateFrames(),this.updateDebugDrawSize()},e.updateFrames=function(){var t=this.constraint,i=t.node,e=N,s=j,n=z,o=V.instance.BT_TRANSFORM_0;l.multiply(e,i.worldScale,t.pivotA),q(T.Transform_getOrigin(o),e);var r=V.instance.BT_QUAT_0;l.normalize(e,t.axis),h.rotationTo(n,l.UNIT_Z,e),tt(r,n),T.Transform_setRotation(o,r);var a=V.instance.BT_TRANSFORM_1,c=this.constraint.connectedBody;c?(l.multiply(e,c.node.worldScale,t.pivotB),h.multiply(n,i.worldRotation,n),h.invert(s,c.node.worldRotation),h.multiply(n,s,n)):(l.multiply(e,i.worldScale,t.pivotA),l.transformQuat(e,e,i.worldRotation),l.add(e,e,i.worldPosition),h.multiply(n,i.worldRotation,n)),q(T.Transform_getOrigin(a),e),tt(r,n),T.Transform_setRotation(a,r),T.HingeConstraint_setFrames(this._impl,o,a)},e.updateScale0=function(){this.updateFrames()},e.updateScale1=function(){this.updateFrames()},a(i,[{key:"constraint",get:function(){return this._com}}]),i}(Gt);!function(t){t[t.RO_XYZ=0]="RO_XYZ",t[t.RO_XZY=1]="RO_XZY",t[t.RO_YXZ=2]="RO_YXZ",t[t.RO_YZX=3]="RO_YZX",t[t.RO_ZXY=4]="RO_ZXY",t[t.RO_ZYX=5]="RO_ZYX"}(Et||(Et={})),function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z",t[t.TWIST=3]="TWIST",t[t.SWING1=4]="SWING1",t[t.SWING2=5]="SWING2"}(At||(At={}));var Vt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e._setLimit=function(t,i,e,s){switch(t){case O.LOCKED:T.Generic6DofSpring2Constraint_setLimit(this._impl,i,0,0);break;case O.LIMITED:T.Generic6DofSpring2Constraint_setLimit(this._impl,i,e,s);break;case O.FREE:T.Generic6DofSpring2Constraint_setLimit(this._impl,i,1,0)}},e.setConstraintMode=function(t,i){var e=this.constraint.linearLimitSettings,s=this.constraint.angularLimitSettings,n=[0,0,0],o=[0,0,0],r=0,a=0;switch(t){case 0:case 1:case 2:l.toArray(n,e.lower),l.toArray(o,e.upper),a=n[t],r=o[t];break;case 3:a=-(r=.5*m(s.twistExtent));break;case 4:a=-(r=.5*m(s.swingExtent1));break;case 5:a=-(r=.5*m(s.swingExtent2));break;default:_("idx should be in [0, 5], but give "+t)}this._setLimit(i,t,a,r)},e.setLinearLimit=function(t,i,e){var s=0,n=this.constraint.linearLimitSettings;switch(t){case 0:s=n.xMotion;break;case 1:s=n.yMotion;break;case 2:s=n.zMotion}this._setLimit(s,t,i,e)},e.setAngularExtent=function(t,i,e){var s=this.constraint.angularLimitSettings;this._setLimit(s.twistMotion,At.TWIST,.5*-m(t),.5*m(t)),this._setLimit(s.swingMotion1,At.SWING1,.5*-m(i),.5*m(i)),this._setLimit(s.swingMotion2,At.SWING2,.5*-m(e),.5*m(e))},e.setSwingSoftConstraint=function(t){T.Generic6DofSpring2Constraint_enableSpring(this._impl,At.SWING1,t),T.Generic6DofSpring2Constraint_enableSpring(this._impl,At.SWING2,t)},e.setTwistSoftConstraint=function(t){T.Generic6DofSpring2Constraint_enableSpring(this._impl,At.TWIST,t)},e.setLinearSoftConstraint=function(t){T.Generic6DofSpring2Constraint_enableSpring(this._impl,At.X,t),T.Generic6DofSpring2Constraint_enableSpring(this._impl,At.Y,t),T.Generic6DofSpring2Constraint_enableSpring(this._impl,At.Z,t)},e.setLinearStiffness=function(t){T.Generic6DofSpring2Constraint_setStiffness(this._impl,At.X,t),T.Generic6DofSpring2Constraint_setStiffness(this._impl,At.Y,t),T.Generic6DofSpring2Constraint_setStiffness(this._impl,At.Z,t)},e.setLinearDamping=function(t){T.Generic6DofSpring2Constraint_setDamping(this._impl,At.X,t),T.Generic6DofSpring2Constraint_setDamping(this._impl,At.Y,t),T.Generic6DofSpring2Constraint_setDamping(this._impl,At.Z,t)},e.setLinearRestitution=function(t){T.Generic6DofSpring2Constraint_setBounce(this._impl,At.X,t),T.Generic6DofSpring2Constraint_setBounce(this._impl,At.Y,t),T.Generic6DofSpring2Constraint_setBounce(this._impl,At.Z,t)},e.setSwingStiffness=function(t){T.Generic6DofSpring2Constraint_setStiffness(this._impl,At.SWING1,t),T.Generic6DofSpring2Constraint_setStiffness(this._impl,At.SWING2,t)},e.setSwingDamping=function(t){T.Generic6DofSpring2Constraint_setDamping(this._impl,At.SWING1,t),T.Generic6DofSpring2Constraint_setDamping(this._impl,At.SWING2,t)},e.setSwingRestitution=function(t){T.Generic6DofSpring2Constraint_setBounce(this._impl,At.SWING1,t),T.Generic6DofSpring2Constraint_setBounce(this._impl,At.SWING2,t)},e.setTwistStiffness=function(t){T.Generic6DofSpring2Constraint_setStiffness(this._impl,At.TWIST,t)},e.setTwistDamping=function(t){T.Generic6DofSpring2Constraint_setDamping(this._impl,At.TWIST,t)},e.setTwistRestitution=function(t){T.Generic6DofSpring2Constraint_setBounce(this._impl,At.TWIST,t)},e.setDriverMode=function(t,i){i===R.DISABLED?T.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!1):i===R.SERVO?(T.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),T.Generic6DofSpring2Constraint_setServo(this._impl,t,!0)):i===R.INDUCTION&&(T.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),T.Generic6DofSpring2Constraint_setServo(this._impl,t,!1))},e._updateMotorTargetAndVelocity=function(t){var i=R.DISABLED,e=0,s=0,n=0,o=this.constraint.linearDriverSettings,r=this.constraint.angularDriverSettings;switch(t){case 0:e=At.X,i=o.xDrive,s=o.targetPosition.x,n=-o.targetVelocity.x;break;case 1:e=At.Y,i=o.yDrive,s=o.targetPosition.y,n=-o.targetVelocity.y;break;case 2:e=At.Z,i=o.zDrive,s=o.targetPosition.z,n=-o.targetVelocity.z;break;case 3:e=At.TWIST,i=r.twistDrive,s=-m(r.targetOrientation.x),n=-m(r.targetVelocity.x);break;case 4:e=At.SWING1,i=r.swingDrive1,s=-m(r.targetOrientation.y),n=-m(r.targetVelocity.y);break;case 5:e=At.SWING2,i=r.swingDrive2,s=-m(r.targetOrientation.z),n=-m(r.targetVelocity.z)}var a=t>2?r.strength:o.strength;T.Generic6DofSpring2Constraint_setServoTarget(this._impl,e,s),i===R.SERVO?t>2?T.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,e,-s*a*.1):T.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,e,s*a*.1):i===R.INDUCTION&&T.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,e,n)},e.setLinearMotorTarget=function(){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)},e.setLinearMotorVelocity=function(){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)},e.setLinearMotorForceLimit=function(t){T.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,At.X,t),T.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,At.Y,t),T.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,At.Z,t)},e.setAngularMotorTarget=function(){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)},e.setAngularMotorVelocity=function(){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)},e.setAngularMotorForceLimit=function(t){T.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,At.TWIST,t),T.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,At.SWING1,t),T.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,At.SWING2,t)},e.setPivotA=function(){this.updateFrames()},e.setPivotB=function(){this.updateFrames()},e.setAutoPivotB=function(){this.updateFrames()},e.setAxis=function(){this.updateFrames()},e.setSecondaryAxis=function(){this.updateFrames()},e.setBreakForce=function(){var t=st(Math.max(this.constraint.breakForce,this.constraint.breakTorque),n.instance.fixedTimeStep);T.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},e.setBreakTorque=function(){var t=st(Math.max(this.constraint.breakForce,this.constraint.breakTorque),n.instance.fixedTimeStep);T.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},e.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t&&t.body.impl||T.TypedConstraint_getFixedBody(),s=V.instance.BT_TRANSFORM_0,n=V.instance.BT_TRANSFORM_1;this._impl=T.Generic6DofSpring2Constraint_new(i,e,s,n,Et.RO_YZX);var o=this.constraint.linearLimitSettings,r=this.constraint.angularLimitSettings;this.setConstraintMode(0,o.xMotion),this.setConstraintMode(1,o.yMotion),this.setConstraintMode(2,o.zMotion),this.setConstraintMode(3,r.twistMotion),this.setConstraintMode(4,r.swingMotion1),this.setConstraintMode(5,r.swingMotion2),this.setLinearSoftConstraint(o.enableSoftConstraint),this.setLinearStiffness(o.stiffness),this.setLinearDamping(o.damping),this.setLinearRestitution(o.restitution),this.setSwingSoftConstraint(r.enableSoftConstraintSwing),this.setSwingRestitution(r.swingRestitution),this.setSwingStiffness(r.swingStiffness),this.setSwingDamping(r.swingDamping),this.setTwistSoftConstraint(r.enableSoftConstraintTwist),this.setTwistRestitution(r.twistRestitution),this.setTwistStiffness(r.twistStiffness),this.setTwistDamping(r.twistDamping);var a=this.constraint.linearDriverSettings,l=this.constraint.angularDriverSettings;this.setDriverMode(0,a.xDrive),this.setDriverMode(1,a.yDrive),this.setDriverMode(2,a.zDrive),this.setDriverMode(3,l.twistDrive),this.setDriverMode(4,l.swingDrive1),this.setDriverMode(5,l.swingDrive2),this.setLinearMotorTarget(a.targetPosition),this.setLinearMotorVelocity(a.targetVelocity),this.setLinearMotorForceLimit(a.strength),this.setAngularMotorTarget(l.targetOrientation),this.setAngularMotorVelocity(l.targetVelocity),this.setAngularMotorForceLimit(l.strength),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames(),this.updateDebugDrawSize()},e.updateFrames=function(){var t=this.constraint,i=t.node,e=N,s=j,n=z,o=V.instance.BT_TRANSFORM_0;l.multiply(e,i.worldScale,t.pivotA),q(T.Transform_getOrigin(o),e);var r=V.instance.BT_QUAT_0,a=t.axis,d=t.secondaryAxis,p=l.cross(W,a,d);c.set(U,a.x,a.y,a.z,0,d.x,d.y,d.z,0,p.x,p.y,p.z,0,0,0,0,1).getRotation(s),tt(r,s),T.Transform_setRotation(o,r);var _=V.instance.BT_TRANSFORM_1,u=this.constraint.connectedBody;u?(h.multiply(s,i.worldRotation,s),h.invert(n,u.node.worldRotation),h.multiply(s,n,s),t.autoPivotB?(l.multiply(e,t.node.worldScale,t.pivotA),l.transformQuat(e,e,i.worldRotation),l.add(e,e,t.node.worldPosition),l.subtract(e,e,u.node.worldPosition),l.transformQuat(e,e,n)):l.multiply(e,u.node.worldScale,t.pivotB)):(l.multiply(e,i.worldScale,t.pivotA),l.transformQuat(e,e,i.worldRotation),l.add(e,e,i.worldPosition),h.multiply(s,i.worldRotation,s)),q(T.Transform_getOrigin(_),e),tt(r,s),T.Transform_setRotation(_,r),T.Generic6DofSpring2Constraint_setFrames(this._impl,o,_)},e.updateScale0=function(){this.updateFrames()},e.updateScale1=function(){this.updateFrames()},a(i,[{key:"constraint",get:function(){return this._com}}]),i}(Gt),Nt=new l(0,0,0),Wt=new l(0,0,0);new l(0,0,0);var Ht=function(){function t(){this.wrappedWorld=void 0,this._isEnabled=!1,this._impl=0,this._comp=null,this._btCollisionFlags=0,this._word3=0,this._dirty=!1,this._collisionFilterGroup=D.DEFAULT,this._collisionFilterMask=-1,this.id=t.idCounter++,this.wrappedWorld=n.instance.physicsWorld}var i=t.prototype;return i.onComponentSet=function(){},i.updateScale=function(){},i.initialize=function(t){this._comp=t;var i=this._comp.group,e=n.instance.collisionMatrix[i];return this._collisionFilterGroup=i,this._collisionFilterMask=e,this.onComponentSet(),0!==this._impl||(_("[Physics]: Initialize BulletCharacterController failed"),!1)},i.setWrapper=function(){V.setWrapper(this._impl,B.CCT_CACHE_NAME,this);var t=T.CharacterController_getCollisionShape(this.impl);V.setWrapper(t,B.CCT_CACHE_NAME,this)},i.onEnable=function(){this._isEnabled=!0,this._impl||this.onComponentSet(),this.setDetectCollisions(!1),this.setOverlapRecovery(!0),n.instance.physicsWorld.addCCT(this),this.setWrapper()},i.onDisable=function(){this._isEnabled=!1,this.wrappedWorld.removeCCT(this),this.onDestroy()},i.onDestroy=function(){T._safe_delete(this._impl,v.EBulletTypeCharacterController),V.delWrapper(this._impl,B.CCT_CACHE_NAME),this._impl=0},i.onLoad=function(){},i.getPosition=function(t){this._impl&&$(t,T.CharacterController_getPosition(this.impl))},i.setPosition=function(t){this._impl&&(q(T.CharacterController_getPosition(this.impl),t),this.syncPhysicsToScene())},i.setContactOffset=function(t){this._impl&&T.CharacterController_setContactOffset(this._impl,t)},i.setStepOffset=function(t){this._impl&&T.CharacterController_setStepOffset(this._impl,t)},i.setSlopeLimit=function(t){this._impl&&T.CharacterController_setSlopeLimit(this._impl,C(t))},i.setDetectCollisions=function(t){this._impl&&T.CharacterController_setCollision(this.impl,t)},i.setOverlapRecovery=function(t){this._impl&&T.CharacterController_setOverlapRecovery(this.impl,t)},i.onGround=function(){return(4&this._btCollisionFlags)>0},i.syncSceneToPhysics=function(){var t=this.characterController.node;t.hasChangedFlags&&(t.hasChangedFlags&e.SCALE&&this.syncScale(),t.hasChangedFlags&e.POSITION&&(l.add(Nt,t.worldPosition,this.scaledCenter),this.setPosition(Nt)))},i.syncPhysicsToScene=function(){this.getPosition(Nt),Nt.subtract(this.scaledCenter),this._comp.node.setWorldPosition(Nt)},i.syncScale=function(){this.updateScale()},i.move=function(t,i,e){if(this._isEnabled){var s=V.instance.BT_V3_0;T.Vec3_set(s,t.x,t.y,t.z),this._btCollisionFlags=T.CharacterController_move(this.impl,s,i,e)}},i.setGroup=function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this._dirty=!0)},i.getGroup=function(){return this._collisionFilterGroup},i.addGroup=function(t){this._collisionFilterGroup|=t,this._dirty=!0},i.removeGroup=function(t){this._collisionFilterGroup&=~t,this._dirty=!0},i.setMask=function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this._dirty=!0)},i.getMask=function(){return this._collisionFilterMask},i.addMask=function(t){this._collisionFilterMask|=t,this._dirty=!0},i.removeMask=function(t){this._collisionFilterMask&=~t,this._dirty=!0},i.updateEventListener=function(){this.wrappedWorld.updateNeedEmitCCTEvents(this.characterController.needCollisionEvent)},i.updateDirty=function(){this._dirty&&(n.instance.physicsWorld.removeCCT(this),n.instance.physicsWorld.addCCT(this),this._dirty=!1)},i.onShapeHitExt=function(t){var i=T.ControllerShapeHit_getHitShape(t),e=n.instance.physicsWorld;e.cctShapeEventDic.get(this.impl,i);var s=new l;$(s,T.ControllerHit_getHitWorldPos(t));var o=new l;$(o,T.ControllerHit_getHitWorldNormal(t));var r=new l;$(r,T.ControllerHit_getHitMotionDir(t));var a=T.ControllerHit_getHitMotionLength(t),h=V.getWrapper(i,ut.TYPE);h&&e.cctShapeEventDic.set(this.impl,i,{BulletCharacterController:this,BulletShape:h,worldPos:s,worldNormal:o,motionDir:r,motionLength:a})},a(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._impl}},{key:"characterController",get:function(){return this._comp}},{key:"scaledCenter",get:function(){return l.multiply(Wt,this._comp.center,this._comp.node.worldScale),Wt}}]),t}();Ht.idCounter=0;var jt=new l(0,0,0),zt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.onComponentSet=function(){this.component.node.getWorldPosition(jt),jt.add(this.scaledCenter);var t=V.instance.BT_V3_0;T.Vec3_set(t,jt.x,jt.y,jt.z);var i=l.UNIT_Y,e=V.instance.BT_V3_1;T.Vec3_set(e,i.x,i.y,i.z);var s=T.ControllerHitReport.implement(at).$$.ptr,o=n.instance.physicsWorld,r=T.CapsuleCharacterControllerDesc_new(C(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,e,t,s,this.component.radius,this.component.height);this._impl=T.CapsuleCharacterController_new(o.impl,r,0),this.updateScale()},e.setRadius=function(){this.updateScale()},e.setHeight=function(){this.updateScale()},e.updateScale=function(){this.updateGeometry()},e.updateGeometry=function(){var t=this.component.node.worldScale,i=this.component.radius*f(t.x,t.z),e=this.component.height*Math.abs(t.y);T.CapsuleCharacterController_setRadius(this.impl,i),T.CapsuleCharacterController_setHeight(this.impl,e),this._dirty=!0},a(i,[{key:"component",get:function(){return this._comp}}]),i}(Ht),Ut=new l(0,0,0),Yt=function(t){function i(){return t.apply(this,arguments)||this}u(i,t);var e=i.prototype;return e.onComponentSet=function(){this.component.node.getWorldPosition(Ut),Ut.add(this.scaledCenter);var t=V.instance.BT_V3_0;T.Vec3_set(t,Ut.x,Ut.y,Ut.z);var i=l.UNIT_Y,e=V.instance.BT_V3_1;T.Vec3_set(e,i.x,i.y,i.z);var s=T.ControllerHitReport.implement(at).$$.ptr,o=n.instance.physicsWorld,r=T.BoxCharacterControllerDesc_new(C(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,e,t,s,this.component.halfHeight,this.component.halfSideExtent,this.component.halfForwardExtent);this._impl=T.BoxCharacterController_new(o.impl,r,0),this.updateScale()},e.setHalfHeight=function(){this.updateScale()},e.setHalfSideExtent=function(){this.updateScale()},e.setHalfForwardExtent=function(){this.updateScale()},e.updateScale=function(){this.updateGeometry()},e.updateGeometry=function(){var t=this.component.node.worldScale;T.BoxCharacterController_setHalfSideExtent(this.impl,this.component.halfSideExtent*t.x),T.BoxCharacterController_setHalfHeight(this.impl,this.component.halfHeight*t.y),T.BoxCharacterController_setHalfForwardExtent(this.impl,this.component.halfForwardExtent*t.z),this._dirty=!0},a(i,[{key:"component",get:function(){return this._comp}}]),i}(Ht);t.once(i.EVENT_PRE_SUBSYSTEM_INIT,(function(){r.register("bullet",{PhysicsWorld:Bt,RigidBody:rt,BoxShape:vt,SphereShape:wt,CapsuleShape:bt,TrimeshShape:Mt,CylinderShape:Ot,ConeShape:Rt,TerrainShape:It,SimplexShape:Ft,PlaneShape:xt,PointToPointConstraint:Lt,HingeConstraint:kt,FixedConstraint:Pt,ConfigurableConstraint:Vt,BoxCharacterController:Yt,CapsuleCharacterController:zt})}))}}}));
