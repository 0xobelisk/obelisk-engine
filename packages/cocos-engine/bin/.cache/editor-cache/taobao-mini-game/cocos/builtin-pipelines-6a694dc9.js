System.register(["./index-433d8403.js","./director-c293a59c.js","./pipeline-state-manager-c8832894.js","./buffer-barrier-8663498b.js"],(function(e){"use strict";var a,r,t,i,d,n,o,s,c,h,w,u,l,g,R,f,p,T,S,E,m,v,A,N,D,C,L,P,O,I,_;return{setters:[function(e){a=e.i},function(e){r=e.bk,t=e.bl,i=e.bm,d=e.bn,n=e.bo,o=e.bp,s=e.bq,c=e.br,h=e.bs,w=e.bt,u=e.bu,l=e.bv,g=e.bw,R=e.bx,f=e.by,p=e.bz,T=e.bA,S=e.l,E=e.L,m=e.f,v=e.bB},function(e){A=e.x},function(e){N=e.T,D=e.b,C=e.L,L=e.t,P=e.a4,O=e.a5,I=e.J,_=e.F}],execute:function(){function M(e){for(var a=e.scene.batches,r=0;a&&r<a.length;r++){var t=a[r];if(e.visibility&t.visFlags)return!0}return!1}e({g:function(e){switch(e){case N.BOOL:case N.INT:case N.UINT:case N.FLOAT:return 1;case N.INT2:case N.FLOAT2:case N.UINT2:case N.BOOL2:return 2;case N.FLOAT3:case N.BOOL3:case N.UINT3:case N.INT3:return 3;case N.BOOL4:case N.FLOAT4:case N.UINT4:case N.INT4:case N.MAT2:return 4;case N.MAT2X3:case N.MAT3X2:return 6;case N.MAT2X4:case N.MAT4X2:return 8;case N.MAT3:return 9;case N.MAT3X4:case N.MAT4X3:return 12;case N.MAT4:return 16;default:return 0}},i:M}),e("O",function(){function e(e){this.pool=[],this.createFunction=void 0,this.createFunction=e}var a=e.prototype;return a.acquire=function(){return this.pool.length>0?this.pool.pop():this.createFunction.apply(this,arguments)},a.release=function(e){this.pool.includes(e)||this.pool.push(e)},a.create=function(){return this.createFunction.apply(this,arguments)},e}());var F=function(e,a,r,t,i){this.camera=void 0,this.id=4294967295,this.windowID=4294967295,this.width=0,this.height=0,this.camera=e,this.id=a,this.windowID=r,this.width=t,this.height=i},B=new Map,b=new Map;function G(e){var a=b.get(e.window);return void 0===a&&(a=b.size,b.set(e.window,a)),a}function x(e,a,r,t){var i=B.get(a);if(void 0!==i){var d=a.window.width,n=a.window.height;0===d&&(d=1),0===n&&(n=1);var o=G(a);return i.width=d,i.height=n,i.windowID=o,t(e,i),i}var s=G(a);return r(e,i=new F(a,B.size,s,a.window.width?a.window.width:1,a.window.height?a.window.height:1)),B.set(a,i),i}function U(e,a,r,t){var i=r,n=t,o=a,s=e.device;if(!e.containsResource(o)){var c=A(s)?D.R32F:D.RGBA8;e.addRenderTarget(o,c,i,n,d.MANAGED),e.addDepthStencil(o+"Depth",D.DEPTH_STENCIL,i,n,d.MANAGED)}e.updateRenderTarget(o,i,n),e.updateDepthStencil(o+"Depth",i,n)}var y=new r;function H(e,a){var r=a.camera;T(e,r);var t=e,i=t.pipelineSceneData.shadows,d=e.pipelineSceneData.validPunctualLights,n=e.pipelineSceneData.shadows;if(y.reset(),!i.enabled||i.type!==S.ShadowMap)return y;y.shadowEnabled=!0;for(var o=y.validLights,s=0,c=0;s<i.maxReceived&&c<d.length;){var h=d[c];h.type===E.SPOT&&h.shadowEnabled&&(o.push(h),s++),c++}var w=r.scene.mainLight,u=n.size.x,l=n.size.y;if(w&&w.shadowEnabled)if(y.mainLightShadowNames[0]="MainLightShadow"+a.id,w.shadowFixedArea)U(e,y.mainLightShadowNames[0],u,l);else{var g=t.pipelineSceneData.csmSupported?w.csmLevel:1;y.mainLightShadowNames[0]="MainLightShadow"+a.id;for(var R=0;R<g;R++)U(e,y.mainLightShadowNames[0],u,l)}for(var f=0;f<o.length;f++){o[f];var p="SpotLightShadow"+f.toString()+a.id;y.spotLightShadowNames[f]=p,U(e,y.spotLightShadowNames[f],u,l)}return y}var Q,z=H;function W(e,a,r,i,d,c,h){var w=c,u=h,l=t(r,c,h,i,d);c=l.width,h=l.height;var g=e;d||((Q=a.addRenderPass(c,h,"default")).name=e,Q.setViewport(new P(0,0,w,u)),Q.addRenderTarget(g,C.CLEAR,L.STORE,new O(1,1,1,r.clearColor.w)),Q.addDepthStencil(g+"Depth",C.CLEAR,L.DISCARD,r.clearDepth,r.clearStencil,I.DEPTH_STENCIL));var R=Q.addQueue(o.RENDER_OPAQUE,"shadow-caster");R.addSceneOfCamera(r,new s(i,d),n.SHADOW_CASTER),R.setViewport(new P(l.x,l.y,l.width,l.height))}function J(e,a){if(y.shadowEnabled){var r=a.camera,t=e.pipelineSceneData.shadows,i=t.size.x,d=t.size.y,n=r.scene.mainLight;if(n&&n.shadowEnabled)if(y.mainLightShadowNames[0]="MainLightShadow"+a.id,n.shadowFixedArea)W(y.mainLightShadowNames[0],e,r,n,0,i,d);else{var o=e.pipelineSceneData.csmSupported?n.csmLevel:1;y.mainLightShadowNames[0]="MainLightShadow"+a.id;for(var s=0;s<o;s++)W(y.mainLightShadowNames[0],e,r,n,s,i,d)}for(var c=0;c<y.validLights.length;c++){var h=y.validLights[c],w="SpotLightShadow"+c.toString()+a.id;y.spotLightShadowNames[c]=w,W(w,e,r,h,0,i,d)}}}function V(e,r,i,d){var c=t(r.camera,r.camera.window.width,r.camera.window.height),h=c.width,w=c.height,u=e.addRenderPass(h,w,"default"),l=r.camera;u.addRenderTarget(i,C.LOAD,L.STORE),u.addDepthStencil(Y.ds,C.LOAD,L.DISCARD);for(var g,R=a(y.mainLightShadowNames);!(g=R()).done;){var f=g.value;e.containsResource(f)&&u.addTexture(f,"cc_shadowMap")}for(var p,T=a(y.spotLightShadowNames);!(p=T()).done;){var S=p.value;e.containsResource(S)&&u.addTexture(S,"cc_spotShadowMap")}var E=n.OPAQUE_OBJECT|n.PLANAR_SHADOW|n.CUTOUT_OBJECT|n.DRAW_INSTANCING;E|=d?n.CLUSTERED_LIGHTING:n.DEFAULT_LIGHTING,u.addQueue(o.RENDER_OPAQUE,"deferred-forward").addSceneOfCamera(l,new s,E),u.addQueue(o.RENDER_TRANSPARENT,"deferred-forward").addSceneOfCamera(l,new s,n.TRANSPARENT_OBJECT|n.GEOMETRY)}function X(e,r,i,d){void 0===i&&(i=!1),void 0===d&&(d=!0),J(e,r);var w=r.id,u=t(r.camera,r.camera.window.width,r.camera.window.height),l=u.width,g=u.height,R=e.addRenderPass(l,g,"default");R.name="ForwardPass"+w,R.setViewport(new P(u.x,u.y,l,g));for(var f,p=a(y.mainLightShadowNames);!(f=p()).done;){var T=f.value;e.containsResource(T)&&R.addTexture(T,"cc_shadowMap")}for(var S,E=a(y.spotLightShadowNames);!(S=E()).done;){var m=S.value;e.containsResource(m)&&R.addTexture(m,"cc_spotShadowMap")}var v=r.camera;R.addRenderTarget("ForwardColor"+r.id,i?C.CLEAR:c(v.clearFlag,h.RENDER_TARGET),L.STORE,new O(v.clearColor.x,v.clearColor.y,v.clearColor.z,v.clearColor.w)),R.addDepthStencil("ForwardDepthStencil"+r.id,i?C.CLEAR:c(v.clearFlag,h.DEPTH_STENCIL),i?L.DISCARD:L.STORE,v.clearDepth,v.clearStencil,v.clearFlag),R.addQueue(o.RENDER_OPAQUE).addSceneOfCamera(v,new s,n.OPAQUE_OBJECT|n.PLANAR_SHADOW|n.CUTOUT_OBJECT|n.DEFAULT_LIGHTING|n.DRAW_INSTANCING);var A=n.TRANSPARENT_OBJECT|n.GEOMETRY;return i||(A|=n.UI,R.showStatistics=!0),d&&R.addQueue(o.RENDER_TRANSPARENT).addSceneOfCamera(v,new s,A),{rtName:"ForwardColor"+r.id,dsName:"ForwardDepthStencil"+r.id}}var j,q,Y=new w;function k(e,a){var r=a.camera,i=t(r,r.window.width,r.window.height),d=i.width,c=i.height,h=Y.color,w=Y.normal,l=Y.emissive,g=Y.ds,R=e.addRenderPass(d,c,"gbuffer");R.name="CameraGBufferPass"+a.id,R.setViewport(new P(i.x,i.y,d,c));var f=new O(0,0,0,0);return r.clearFlag&I.COLOR&&(e.pipelineSceneData.isHDR?u(f,r.clearColor):(f.x=r.clearColor.x,f.y=r.clearColor.y,f.z=r.clearColor.z)),R.addRenderTarget(h,C.CLEAR,L.STORE,f),R.addRenderTarget(l,C.CLEAR,L.STORE,new O(0,0,0,0)),R.addRenderTarget(w,C.CLEAR,L.STORE,new O(0,0,0,0)),R.addDepthStencil(g,C.CLEAR,L.STORE,r.clearDepth,r.clearStencil,r.clearFlag),R.addQueue(o.RENDER_OPAQUE,"gbuffer").addSceneOfCamera(r,new s,n.OPAQUE_OBJECT|n.CUTOUT_OBJECT),R}function K(e,r,i){J(e,r),j||(j=new l(i));var d=e,s=r.camera,c=t(s,s.window.width,s.window.height),h=c.width,w=c.height,u=g(s),f="deferredLightingPassRTName"+r.id,p=d.addRenderPass(h,w,"deferred-lighting");p.name="CameraLightingPass"+r.id,p.setViewport(new P(c.x,c.y,h,w));for(var T,S=a(y.mainLightShadowNames);!(T=S()).done;){var E=T.value;d.containsResource(E)&&p.addTexture(E,"cc_shadowMap")}for(var m,v=a(y.spotLightShadowNames);!(m=v()).done;){var A=m.value;d.containsResource(A)&&p.addTexture(A,"cc_spotShadowMap")}d.containsResource(Y.color)&&(p.addTexture(Y.color,"albedoMap"),p.addTexture(Y.normal,"normalMap"),p.addTexture(Y.emissive,"emissiveMap"),p.addTexture(Y.ds,"depthStencil"));var N="clusterLightBuffer"+u,D="clusterLightIndicesBuffer"+u,_="clusterLightGridBuffer"+u;d.containsResource(N)&&(p.addStorageBuffer(N,R.READ,"b_ccLightsBuffer"),p.addStorageBuffer(D,R.READ,"b_clusterLightIndicesBuffer"),p.addStorageBuffer(_,R.READ,"b_clusterLightGridBuffer"));var M=new O(0,0,0,0);return s.clearFlag&I.COLOR&&(M.x=s.clearColor.x,M.y=s.clearColor.y,M.z=s.clearColor.z),M.w=0,p.addRenderTarget(f,C.CLEAR,L.STORE,M),p.addQueue(o.RENDER_TRANSPARENT).addCameraQuad(s,j.deferredLightingMaterial,0,n.VOLUMETRIC_LIGHTING),{rtName:f}}function Z(e,a,r){q||(q=new f);var i=a.id,d=a.camera,s=t(d,d.window.width,d.window.height),w=s.width,u=s.height,l="postprocessPassRTName"+i,g="postprocessPassDS"+i,R=e.addRenderPass(w,u,"post-process");R.name="CameraPostprocessPass"+i,R.setViewport(new P(s.x,s.y,s.width,s.height)),e.containsResource(r)&&R.addTexture(r,"outputResultMap");var T=new O(0,0,0,d.clearColor.w);return d.clearFlag&I.COLOR&&(T.x=d.clearColor.x,T.y=d.clearColor.y,T.z=d.clearColor.z),R.addRenderTarget(l,c(d.clearFlag,h.RENDER_TARGET),L.STORE,T),R.addDepthStencil(g,c(d.clearFlag,h.DEPTH_STENCIL),L.STORE,d.clearDepth,d.clearStencil,d.clearFlag),R.addQueue(o.NONE).addCameraQuad(d,q.postMaterial,0,n.NONE),p()===d&&(R.showStatistics=!0),{rtName:l,dsName:g}}function $(e,a){var r=a.camera,i=t(r,r.window.width,r.window.height),d=i.width,w=i.height,u="dsUIAndProfilerPassColor"+a.id,l="dsUIAndProfilerPassDS"+a.id,g=e.addRenderPass(d,w,"default");g.name="CameraUIAndProfilerPass"+a.id,g.setViewport(new P(i.x,i.y,d,w)),g.addRenderTarget(u,c(r.clearFlag,h.RENDER_TARGET),L.STORE,new O(r.clearColor.x,r.clearColor.y,r.clearColor.z,r.clearColor.w)),g.addDepthStencil(l,c(r.clearFlag,h.DEPTH_STENCIL),L.STORE,r.clearDepth,r.clearStencil,r.clearFlag);var R=n.UI;g.addQueue(o.RENDER_TRANSPARENT).addSceneOfCamera(r,new s,R),p()===r&&(g.showStatistics=!0)}new O(0,0,0,0),e("F",function(){function e(){}var a=e.prototype;return a.setup=function(e,a){for(var r=0;r<e.length;r++){var t=e[r];null!==t.scene&&(a.update(t),X(a,x(a,t,this.initResource,this.updateResource)))}},a.initResource=function(e,a){!function(e,a,r){void 0===r&&(r=!1);var n=a.camera,o=t(n,n.window.width,n.window.height),s=o.width,c=o.height;H(e,a),r?e.addRenderTarget("ForwardColor"+a.id,i(e),s,c,d.PERSISTENT):e.addRenderWindow("ForwardColor"+a.id,D.BGRA8,s,c,a.camera.window),e.addDepthStencil("ForwardDepthStencil"+a.id,D.DEPTH_STENCIL,s,c)}(e,a)},a.updateResource=function(e,a){!function(e,a,r){void 0===r&&(r=!1);var i=a.camera,d=t(i,i.window.width,i.window.height),n=d.width,o=d.height;z(e,a),r?e.updateRenderTarget("ForwardColor"+a.id,n,o):e.updateRenderWindow("ForwardColor"+a.id,a.camera.window),e.updateDepthStencil("ForwardDepthStencil"+a.id,n,o)}(e,a)},e}()),e("D",function(){function e(){}var a=e.prototype;return a.setup=function(e,a){for(var r=0;r<e.length;++r){var t=e[r];if(t.scene){a.update(t);var i=a.device.hasFeature(_.COMPUTE_SHADER),d=t.cameraUsage===m.GAME||t.cameraUsage===m.GAME_VIEW,n=x(a,t,this.initResource,this.updateResource);if(d)if(M(t))$(a,n);else{i&&v(t,a),k(a,n);var o=K(a,n,i);V(a,n,o.rtName,i),Z(a,n,o.rtName)}else X(a,n)}}},a.initResource=function(e,a){M(a.camera)?function(e,a){var r=a.camera,i=t(r,r.window.width,r.window.height),n=i.width,o=i.height,s="dsUIAndProfilerPassColor"+a.id,c="dsUIAndProfilerPassDS"+a.id;e.addRenderWindow(s,D.BGRA8,n,o,r.window),e.addDepthStencil(c,D.DEPTH_STENCIL,n,o,d.MANAGED)}(e,a):(function(e,a){var r=a.camera,i=t(r,r.window.width,r.window.height),n=i.width,o=i.height,s="gBufferPassColorCamera"+a.id,c="gBufferPassNormal"+a.id,h="gBufferPassEmissive"+a.id,w="gBufferPassDSCamera"+a.id,u=D.RGBA16F;e.addRenderTarget(s,u,n,o,d.MANAGED),e.addRenderTarget(h,u,n,o,d.MANAGED),e.addRenderTarget(c,u,n,o,d.MANAGED),e.addDepthStencil(w,D.DEPTH_STENCIL,n,o,d.MANAGED),Y.color=s,Y.normal=c,Y.emissive=h,Y.ds=w}(e,a),function(e,a){H(e,a);var r=a.camera,i=t(r,r.window.width,r.window.height),n=i.width,o=i.height,s="deferredLightingPassRTName"+a.id;e.addRenderTarget(s,D.RGBA8,n,o,d.MANAGED)}(e,a),function(e,a){var r=a.id,i=a.camera,n=t(i,i.window.width,i.window.height),o=n.width,s=n.height,c="postprocessPassRTName"+r,h="postprocessPassDS"+r;e.addRenderWindow(c,D.BGRA8,o,s,i.window),e.addDepthStencil(h,D.DEPTH_STENCIL,o,s,d.MANAGED)}(e,a))},a.updateResource=function(e,a){M(a.camera)?function(e,a){var r=a.camera,i=t(r,r.window.width,r.window.height),d=i.width,n=i.height,o="dsUIAndProfilerPassColor"+a.id,s="dsUIAndProfilerPassDS"+a.id;e.updateRenderWindow(o,r.window),e.updateDepthStencil(s,d,n)}(e,a):(function(e,a){var r=a.camera,i=t(r,r.window.width,r.window.height),d=i.width,n=i.height,o="gBufferPassColorCamera"+a.id,s="gBufferPassNormal"+a.id,c="gBufferPassEmissive"+a.id,h="gBufferPassDSCamera"+a.id;e.updateRenderTarget(o,d,n),e.updateRenderTarget(c,d,n),e.updateRenderTarget(s,d,n),e.updateDepthStencil(h,d,n)}(e,a),function(e,a){z(e,a);var r=a.camera,i=t(r,r.window.width,r.window.height),d=i.width,n=i.height,o="deferredLightingPassRTName"+a.id;e.updateRenderTarget(o,d,n)}(e,a),function(e,a){var r=a.id,i=a.camera,d=t(i,i.window.width,i.window.height),n=d.width,o=d.height,s="postprocessPassRTName"+r,c="postprocessPassDS"+r;e.updateRenderWindow(s,i.window),e.updateDepthStencil(c,n,o)}(e,a))},e}())}}}));
